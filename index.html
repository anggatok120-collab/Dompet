<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Dompet ‚Äî Manajemen Keuangan Pribadi</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563EB">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Dompet">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F5F6FA;--white:#FFFFFF;--border:#E8EAED;--border2:#D1D5DB;
  --text:#1A1D23;--sub:#6B7280;--faint:#F9FAFB;
  --primary:#2563EB;--primary-light:#EFF6FF;--primary-dark:#1D4ED8;
  --green:#16A34A;--green-light:#F0FDF4;
  --red:#DC2626;--red-light:#FEF2F2;
  --yellow:#D97706;--yellow-light:#FFFBEB;
  --purple:#7C3AED;--purple-light:#F5F3FF;
  --font:'Plus Jakarta Sans',sans-serif;
}
/* ===== THEMES ===== */
[data-theme="dark"]{
  --bg:#0F1117;--white:#1A1D27;--border:#2A2D3A;--border2:#3A3D4A;
  --text:#E8ECF4;--sub:#8B909E;--faint:#13151E;
  --primary:#4F7FFF;--primary-light:#1A2040;--primary-dark:#3A6AEE;
  --green:#34D399;--green-light:#0D2A1F;
  --red:#F87171;--red-light:#2A1010;
  --yellow:#FBBF24;--yellow-light:#2A2010;
  --purple:#A78BFA;--purple-light:#1E1535;
}
[data-theme="forest"]{
  --bg:#F0F5F1;--white:#FFFFFF;--border:#D4E4D8;--border2:#B8D4BE;
  --text:#1A2E1E;--sub:#5A7A62;--faint:#F5FAF6;
  --primary:#16A34A;--primary-light:#F0FDF4;--primary-dark:#15803D;
  --green:#059669;--green-light:#ECFDF5;
  --red:#DC2626;--red-light:#FEF2F2;
  --yellow:#CA8A04;--yellow-light:#FEFCE8;
  --purple:#7C3AED;--purple-light:#F5F3FF;
}
[data-theme="rose"]{
  --bg:#FFF5F6;--white:#FFFFFF;--border:#FDDDE0;--border2:#FBC5CA;
  --text:#2A1015;--sub:#9B6B72;--faint:#FFF8F9;
  --primary:#E11D48;--primary-light:#FFF1F2;--primary-dark:#BE123C;
  --green:#16A34A;--green-light:#F0FDF4;
  --red:#E11D48;--red-light:#FFF1F2;
  --yellow:#D97706;--yellow-light:#FFFBEB;
  --purple:#7C3AED;--purple-light:#F5F3FF;
}
[data-theme="slate"]{
  --bg:#1E2130;--white:#252938;--border:#323650;--border2:#424668;
  --text:#CDD5F0;--sub:#8892B0;--faint:#1A1D2E;
  --primary:#64B5F6;--primary-light:#1A2540;--primary-dark:#42A5F5;
  --green:#81C784;--green-light:#0D2010;
  --red:#EF9A9A;--red-light:#2A1010;
  --yellow:#FFD54F;--yellow-light:#2A2010;
  --purple:#CE93D8;--purple-light:#1E1535;
}
/* theme swatch button */
.theme-swatch{width:32px;height:32px;border-radius:8px;border:3px solid transparent;cursor:pointer;transition:all .15s;flex-shrink:0}
.theme-swatch.active{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-light)}
.theme-swatch:hover{transform:scale(1.1)}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

/* LAYOUT */
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--white);border-right:1px solid var(--border);padding:0;position:fixed;top:0;left:0;height:100vh;display:flex;flex-direction:column;z-index:100}
.main{margin-left:220px;padding:24px;min-height:100vh;max-width:calc(100vw - 220px)}

/* SIDEBAR */
.sidebar-header{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
.app-name{font-size:18px;font-weight:700;color:var(--primary);letter-spacing:-.3px}
.app-tagline{font-size:11px;color:var(--sub);margin-top:2px}
.sync-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:5px;vertical-align:middle}
.sync-ok{background:var(--green)}.sync-loading{background:var(--yellow)}.sync-err{background:var(--red)}
.sync-label{font-size:11px;color:var(--sub);padding:8px 16px}

.nav-section{padding:12px 0}
.nav-label{font-size:10px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:1px;padding:4px 16px 8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;border-radius:0;font-size:13px;font-weight:500;color:var(--sub);transition:all .15s;border-left:3px solid transparent;user-select:none}
.nav-item:hover{background:var(--faint);color:var(--text)}
.nav-item.active{background:var(--primary-light);color:var(--primary);border-left-color:var(--primary);font-weight:600}
.nav-icon{font-size:16px;width:20px;text-align:center}
.nav-badge{background:var(--primary);color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:auto}

.sidebar-footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--border)}
.btn-add-tx{width:100%;background:var(--primary);color:white;border:none;padding:10px;border-radius:10px;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-add-tx:hover{background:var(--primary-dark)}

/* TOP BAR */
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.page-title{font-size:20px;font-weight:700;letter-spacing:-.3px}
.topbar-actions{display:flex;gap:8px;align-items:center}

/* CARDS */
.card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:16px}
.card-title{font-size:13px;font-weight:600;color:var(--sub);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
.stat-balance::before{background:var(--primary)}
.stat-income::before{background:var(--green)}
.stat-expense::before{background:var(--red)}
.stat-saving::before{background:var(--purple)}
.stat-icon{font-size:22px;margin-bottom:8px;display:block}
.stat-label{font-size:11px;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.stat-value{font-size:20px;font-weight:700;margin-top:4px;letter-spacing:-.5px}
.stat-change{font-size:11px;margin-top:4px}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.mb16{margin-bottom:16px}

/* FORM */
.modal-overlay{position:fixed;inset:0;background:#00000044;z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex;animation:fadeIn .2s ease}
.modal{background:var(--white);border-radius:16px;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #00000022}
.modal-title{font-size:16px;font-weight:700;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--sub);line-height:1}
.form-group{margin-bottom:14px}
.form-label{font-size:12px;font-weight:600;color:var(--sub);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
input,select,textarea{background:var(--faint);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:var(--font);font-size:13px;padding:9px 12px;width:100%;outline:none;transition:all .15s}
input:focus,select:focus,textarea:focus{border-color:var(--primary);background:white;box-shadow:0 0 0 3px #2563EB18}
select option{background:white}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.type-tabs{display:flex;gap:0;border:1px solid var(--border2);border-radius:8px;overflow:hidden;margin-bottom:14px}
.type-tab{flex:1;border:none;background:none;padding:9px;font-family:var(--font);font-size:13px;cursor:pointer;font-weight:500;color:var(--sub);transition:all .15s}
.type-tab.income{background:var(--green-light);color:var(--green);font-weight:600}
.type-tab.expense{background:var(--red-light);color:var(--red);font-weight:600}

/* BUTTONS */
.btn{border:none;border-radius:8px;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;padding:9px 18px}
.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-success{background:var(--green);color:white}.btn-success:hover{background:#15803D}
.btn-danger{background:var(--red);color:white}
.btn-ghost{background:none;border:1px solid var(--border2);color:var(--sub)}.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px}
.btn-xs{padding:4px 8px;font-size:11px;border-radius:5px}
.btn-icon{background:none;border:1px solid var(--border);border-radius:7px;padding:6px 10px;cursor:pointer;font-size:13px;transition:all .15s;color:var(--sub)}
.btn-icon:hover{border-color:var(--primary);color:var(--primary)}

/* TABLE / LIST */
.tx-list{}
.tx-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)}
.tx-item:last-child{border-bottom:none}
.tx-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.tx-cat{font-size:13px;font-weight:600}
.tx-meta{font-size:11px;color:var(--sub);margin-top:1px}
.tx-amt{font-size:14px;font-weight:700;text-align:right}
.tx-date{font-size:11px;color:var(--sub);text-align:right;margin-top:1px}
.del-btn{background:none;border:none;color:var(--border2);cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px;transition:color .15s}
.del-btn:hover{color:var(--red)}
.tag-pill{background:var(--faint);border:1px solid var(--border);border-radius:5px;padding:1px 7px;font-size:10px;color:var(--sub);margin-left:5px}

/* BAR */
.progress-bar{background:var(--bg);border-radius:4px;height:6px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .6s ease}

/* FILTER / SEARCH */
.search-bar{position:relative;flex:1}
.search-bar input{padding-left:32px}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--sub);font-size:14px;pointer-events:none}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.pill{background:var(--faint);border:1px solid var(--border);color:var(--sub);padding:5px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
.pill.active,.pill:hover{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.pill.active{font-weight:600}

/* CHART BARS */
.hbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.hbar-label{width:80px;font-size:12px;font-weight:500;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hbar-track{flex:1;background:var(--bg);border-radius:4px;height:8px}
.hbar-fill{height:100%;border-radius:4px;transition:width .7s ease}
.hbar-val{width:80px;text-align:right;font-size:11px;color:var(--sub);flex-shrink:0}

/* TREND */
.trend-wrap{display:flex;gap:6px;align-items:flex-end;height:80px}
.trend-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.trend-bars{display:flex;gap:2px;align-items:flex-end;height:60px}
.tbar{width:12px;border-radius:3px 3px 0 0;min-height:2px;transition:height .7s ease}
.trend-lbl{font-size:9px;color:var(--sub)}

/* BUDGET */
.budget-row{padding:12px 0;border-bottom:1px solid var(--border)}
.budget-row:last-child{border-bottom:none}
.budget-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.budget-pct{font-size:11px;font-weight:700}

/* SAVINGS GOAL */
.goal-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.goal-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.goal-name{font-size:13px;font-weight:600}
.goal-target{font-size:11px;color:var(--sub)}
.goal-pct{font-size:18px;font-weight:700;color:var(--primary)}

/* RECURRING */
.recur-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.recur-item:last-child{border-bottom:none}

/* INSIGHT */
.insight{background:var(--faint);border-left:3px solid var(--primary);border-radius:0 8px 8px 0;padding:12px 14px;margin-bottom:10px}
.insight.green{border-left-color:var(--green);background:var(--green-light)}
.insight.red{border-left-color:var(--red);background:var(--red-light)}
.insight.yellow{border-left-color:var(--yellow);background:var(--yellow-light)}
.insight-title{font-size:12px;font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
.insight-text{font-size:13px;line-height:1.5;color:var(--text)}

/* CHAT */
.chat-wrap{display:flex;flex-direction:column;height:320px}
.chat-area{flex:1;overflow-y:auto;padding:4px 0;display:flex;flex-direction:column;gap:10px}
.cbubble{padding:10px 14px;border-radius:12px;max-width:80%;font-size:13px;line-height:1.6;white-space:pre-wrap}
.cbubble-user{background:var(--primary);color:white;border-radius:12px 12px 3px 12px;margin-left:auto}
.cbubble-ai{background:var(--faint);border:1px solid var(--border);color:var(--text);border-radius:12px 12px 12px 3px}
.chat-input{display:flex;gap:8px;margin-top:10px}
.qdot{width:8px;height:8px;border-radius:50%;background:var(--primary);display:inline-block;margin:0 2px;animation:pulse 1.2s infinite}
.qdot:nth-child(2){animation-delay:.15s}.qdot:nth-child(3){animation-delay:.3s}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;padding:11px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;animation:slideRight .25s ease;box-shadow:0 4px 20px #00000022}
.toast-ok{background:var(--green);color:white}
.toast-err{background:var(--red);color:white}
.toast-info{background:var(--primary);color:white}

/* MISC */
.empty{color:var(--sub);text-align:center;padding:24px;font-size:13px}
.divider{height:1px;background:var(--border);margin:14px 0}
.spinner{display:inline-block;width:12px;height:12px;border:2px solid #ffffff44;border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;margin-right:6px;vertical-align:middle}
.section{display:none}.section.active{display:block;animation:fadeIn .2s ease}
.text-green{color:var(--green)}.text-red{color:var(--red)}.text-blue{color:var(--primary)}.text-sub{color:var(--sub)}
.fw600{font-weight:600}.fw700{font-weight:700}
.flex{display:flex}.flex-between{display:flex;justify-content:space-between;align-items:center}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideRight{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:.2;transform:scale(.7)}50%{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:900px){.stats-grid{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}}
@media(max-width:700px){
  .sidebar{width:100%;height:auto;position:relative;flex-direction:row;flex-wrap:wrap}
  .main{margin-left:0;padding:14px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr}
}
/* ===== OFFLINE BANNER ===== */
#offline-banner{display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:#D97706;color:white;text-align:center;padding:9px 16px;font-size:13px;font-weight:600}
#offline-banner.show{display:block}
#pwa-install-btn{display:none;position:fixed;bottom:84px;right:16px;z-index:999;background:var(--primary);color:white;border:none;border-radius:50px;padding:12px 20px;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(37,99,235,.4);font-family:var(--font);align-items:center;gap:8px}
#pwa-install-btn.show{display:flex}
</style>
</head>
<body>
<!-- Offline Banner -->
<div id="offline-banner">üìµ Tidak ada koneksi internet ‚Äî data tersimpan lokal, akan sync otomatis saat online</div>
<!-- PWA Install Button -->
<button id="pwa-install-btn" onclick="installPWA()">üì≤ Install Aplikasi</button>

<div class="app">

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="app-name">üí∞ Dompet</div>
    <div class="app-tagline">Manajemen Keuangan Pribadi</div>
  </div>
  <div class="sync-label"><span class="sync-dot sync-loading" id="syncDot"></span><span id="syncText">Menghubungkan...</span></div>

  <div class="nav-section">
    <div class="nav-label">Menu</div>
    <div class="nav-item active" onclick="showPage('dashboard',this)"><span class="nav-icon">üìä</span>Dashboard</div>
    <div class="nav-item" onclick="showPage('history',this)"><span class="nav-icon">üìã</span>Riwayat</div>
    <div class="nav-item" onclick="showPage('budget',this)"><span class="nav-icon">üéØ</span>Anggaran</div>
    <div class="nav-item" onclick="showPage('goals',this)"><span class="nav-icon">üèÜ</span>Target Tabungan</div>
    <div class="nav-item" onclick="showPage('recurring',this)"><span class="nav-icon">üîÅ</span>Transaksi Rutin</div>
    <div class="nav-item" onclick="showPage('reports',this)"><span class="nav-icon">üìà</span>Laporan</div>
    <div class="nav-item" onclick="showPage('insights',this)"><span class="nav-icon">üí°</span>Analisis</div>
    <div class="nav-item" onclick="showPage('ai',this)"><span class="nav-icon">ü§ñ</span>AI Advisor</div>
    <div class="nav-label" style="margin-top:6px">Uang Tunai</div>
    <div class="nav-item" onclick="showPage('cash',this)"><span class="nav-icon">üíµ</span>Manajemen Kas</div>
    <div class="nav-item" onclick="showPage('settings',this)"><span class="nav-icon">‚öôÔ∏è</span>Pengaturan</div>
  </div>

  <div class="sidebar-footer">
    <button class="btn-add-tx" onclick="openModal('addTx')">+ Catat Transaksi</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">

<!-- ======= DASHBOARD ======= -->
<div id="dashboard" class="section active">
  <div class="topbar">
    <div class="page-title">Dashboard</div>
    <div class="topbar-actions">
      <span id="headerDate" style="font-size:12px;color:var(--sub)"></span>
      <button class="btn btn-ghost btn-sm" onclick="loadData()">üîÑ Refresh</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card stat-balance"><span class="stat-icon">üí∞</span><div class="stat-label">Saldo Bersih</div><div class="stat-value text-blue" id="s-balance">‚Äî</div><div class="stat-change" id="s-rate"></div></div>
    <div class="stat-card stat-income"><span class="stat-icon">üìà</span><div class="stat-label">Pemasukan</div><div class="stat-value text-green" id="s-income">‚Äî</div><div class="stat-change text-sub" id="s-income-count"></div></div>
    <div class="stat-card stat-expense"><span class="stat-icon">üìâ</span><div class="stat-label">Pengeluaran</div><div class="stat-value text-red" id="s-expense">‚Äî</div><div class="stat-change text-sub" id="s-expense-count"></div></div>
    <div class="stat-card stat-saving"><span class="stat-icon">üè¶</span><div class="stat-label">Rasio Tabungan</div><div class="stat-value" style="color:var(--purple)" id="s-saving">‚Äî</div><div class="stat-change text-sub">dari total pemasukan</div></div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Pengeluaran per Kategori</div>
      <div id="d-catbar"></div>
    </div>
    <div class="card">
      <div class="card-title">Tren 6 Bulan</div>
      <div style="display:flex;gap:14px;margin-bottom:10px">
        <span style="font-size:11px;font-weight:600;color:var(--green)">‚ñ¨ Pemasukan</span>
        <span style="font-size:11px;font-weight:600;color:var(--red)">‚ñ¨ Pengeluaran</span>
      </div>
      <div class="trend-wrap" id="d-trend"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="flex-between" style="margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">Transaksi Terbaru</div>
        <button class="btn btn-ghost btn-xs" onclick="showPage('history',document.querySelectorAll('.nav-item')[1])">Lihat semua</button>
      </div>
      <div id="d-recent"></div>
    </div>
    <div class="card">
      <div class="card-title">Status Anggaran Bulan Ini</div>
      <div id="d-budget"></div>
    </div>
  </div>
</div>

<!-- ======= HISTORY ======= -->
<div id="history" class="section">
  <div class="topbar">
    <div class="page-title">Riwayat Transaksi</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì§ Export CSV</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('addTx')">+ Catat</button>
    </div>
  </div>

  <div class="card mb16">
    <div class="filters" id="h-monthFilter"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div class="search-bar" style="max-width:240px">
        <span class="search-icon">üîç</span>
        <input type="text" id="h-search" placeholder="Cari transaksi...">
      </div>
      <select id="h-catFilter" style="width:140px;padding:7px 10px">
        <option value="">Semua Kategori</option>
      </select>
      <div style="display:flex;gap:6px;margin-left:auto">
        <span class="pill" onclick="setTxType('all',this)">Semua</span>
        <span class="pill" onclick="setTxType('income',this)">Masuk</span>
        <span class="pill" onclick="setTxType('expense',this)">Keluar</span>
      </div>
    </div>
    <div id="h-summary" style="display:flex;gap:16px;padding:10px;background:var(--faint);border-radius:8px;margin-bottom:12px;flex-wrap:wrap"></div>
    <div id="h-list"></div>
  </div>
</div>

<!-- ======= BUDGET ======= -->
<div id="budget" class="section">
  <div class="topbar">
    <div class="page-title">Anggaran Bulanan</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('addBudget')">+ Atur Anggaran</button>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Status Anggaran ‚Äî <span id="bud-month"></span></div>
      <div id="bud-status"></div>
    </div>
    <div class="card">
      <div class="card-title">Ringkasan Anggaran</div>
      <div id="bud-summary"></div>
    </div>
  </div>
</div>

<!-- ======= SAVINGS GOALS ======= -->
<div id="goals" class="section">
  <div class="topbar">
    <div class="page-title">Target Tabungan</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('addGoal')">+ Target Baru</button>
  </div>
  <div id="goals-list" class="grid-2"></div>
</div>

<!-- ======= RECURRING ======= -->
<div id="recurring" class="section">
  <div class="topbar">
    <div class="page-title">Transaksi Rutin</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('addRecurring')">+ Tambah Rutin</button>
  </div>
  <div class="card">
    <div style="margin-bottom:10px;font-size:12px;color:var(--sub)">üí° Transaksi rutin membantu kamu mencatat cicilan, langganan, dan pembayaran berkala lainnya.</div>
    <div id="recur-list"></div>
  </div>
</div>

<!-- ======= REPORTS ======= -->
<div id="reports" class="section">
  <div class="topbar">
    <div class="page-title">Laporan Keuangan</div>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì§ Export CSV</button>
  </div>

  <div class="grid-3">
    <div class="card"><div class="card-title">Hari Ini</div><div id="rep-today"></div></div>
    <div class="card"><div class="card-title">Minggu Ini</div><div id="rep-week"></div></div>
    <div class="card"><div class="card-title">Bulan Ini</div><div id="rep-month"></div></div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Pemasukan per Kategori</div>
      <div id="rep-income-cat"></div>
    </div>
    <div class="card">
      <div class="card-title">Pengeluaran per Kategori</div>
      <div id="rep-expense-cat"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Ringkasan Bulanan</div>
    <div id="rep-monthly-table" style="overflow-x:auto"></div>
  </div>
</div>

<!-- ======= INSIGHTS ======= -->
<div id="insights" class="section">
  <div class="topbar"><div class="page-title">Analisis Cerdas</div></div>
  <div class="grid-2">
    <div>
      <div class="card mb16"><div class="card-title">Insight Keuangan</div><div id="ins-cards"></div></div>
    </div>
    <div>
      <div class="card mb16"><div class="card-title">Statistik Detail</div><div id="ins-stats"></div></div>
      <div class="card"><div class="card-title">Hari Pengeluaran Terbanyak</div><div id="ins-days"></div></div>
    </div>
  </div>
</div>

<!-- ======= AI ADVISOR ======= -->
<div id="ai" class="section">
  <div class="topbar"><div class="page-title">AI Financial Advisor</div></div>
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)">
      <div style="width:42px;height:42px;border-radius:10px;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-size:22px">ü§ñ</div>
      <div><div style="font-weight:700;font-size:15px">Penasihat AI</div><div style="font-size:12px;color:var(--green);margin-top:1px">‚óè Memiliki akses data keuanganmu</div></div>
    </div>

    <div class="chat-wrap">
      <div class="chat-area" id="chatArea">
        <div id="chatEmpty" style="text-align:center;padding:20px">
          <div style="font-size:32px;margin-bottom:8px">üí¨</div>
          <div style="color:var(--sub);font-size:13px;margin-bottom:14px">Tanyakan apa saja tentang kondisi keuanganmu</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center">
            <span class="pill" onclick="setQ('Bagaimana kondisi keuanganku sekarang?')" style="cursor:pointer">Kondisi keuangan</span>
            <span class="pill" onclick="setQ('Di mana saya paling boros?')" style="cursor:pointer">Saya paling boros?</span>
            <span class="pill" onclick="setQ('Berikan tips menabung untuk situasi saya')" style="cursor:pointer">Tips menabung</span>
            <span class="pill" onclick="setQ('Buat rencana keuangan bulan depan')" style="cursor:pointer">Rencana bulan depan</span>
            <span class="pill" onclick="setQ('Apakah anggaran saya realistis?')" style="cursor:pointer">Cek anggaran</span>
          </div>
        </div>
      </div>
      <div class="chat-input">
        <input type="text" id="aiInput" placeholder="Tanya AI tentang keuanganmu..." onkeydown="if(event.key==='Enter')sendAI()">
        <button class="btn btn-primary" onclick="sendAI()" id="sendBtn" style="padding:9px 16px">‚Üí</button>
      </div>
    </div>

    <div class="divider"></div>
    <div style="font-size:12px;font-weight:600;color:var(--sub);margin-bottom:8px">API KEY ANTHROPIC</div>
    <div style="display:flex;gap:8px">
      <input type="password" id="apiKey" placeholder="sk-ant-..." style="flex:1;font-size:12px">
      <button class="btn btn-ghost btn-sm" onclick="saveKey()">Simpan</button>
    </div>
    <div style="font-size:11px;color:var(--sub);margin-top:6px">üîí Tersimpan di browser kamu saja.</div>
  </div>
</div>

<!-- ======= SETTINGS ======= -->
<div id="settings" class="section">
  <div class="topbar"><div class="page-title">Pengaturan</div></div>

  <!-- THEME PICKER -->
  <div class="card mb16">
    <div class="card-title">üé® Tema Tampilan</div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px">
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="setTheme('light')">
        <div class="theme-swatch" id="swatch-light" style="background:linear-gradient(135deg,#F5F6FA 50%,#2563EB 50%)"></div>
        <span style="font-size:11px;font-weight:500;color:var(--sub)">Default</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="setTheme('dark')">
        <div class="theme-swatch" id="swatch-dark" style="background:linear-gradient(135deg,#0F1117 50%,#4F7FFF 50%)"></div>
        <span style="font-size:11px;font-weight:500;color:var(--sub)">Gelap</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="setTheme('forest')">
        <div class="theme-swatch" id="swatch-forest" style="background:linear-gradient(135deg,#F0F5F1 50%,#16A34A 50%)"></div>
        <span style="font-size:11px;font-weight:500;color:var(--sub)">Hutan</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="setTheme('rose')">
        <div class="theme-swatch" id="swatch-rose" style="background:linear-gradient(135deg,#FFF5F6 50%,#E11D48 50%)"></div>
        <span style="font-size:11px;font-weight:500;color:var(--sub)">Mawar</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="setTheme('slate')">
        <div class="theme-swatch" id="swatch-slate" style="background:linear-gradient(135deg,#1E2130 50%,#64B5F6 50%)"></div>
        <span style="font-size:11px;font-weight:500;color:var(--sub)">Biru Malam</span>
      </div>
    </div>
    <div style="font-size:12px;color:var(--sub)">Tema aktif: <strong id="active-theme-label">Default</strong> ‚Äî tersimpan otomatis</div>
  </div>

  <!-- DATE SETTINGS -->
  <div class="card mb16">
    <div class="card-title">üìÖ Pengaturan Tanggal</div>
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Format Tanggal</label>
        <select id="cfg-datefmt" onchange="saveDateSettings()">
          <option value="id">DD Bulan YYYY (Indonesia)</option>
          <option value="iso">YYYY-MM-DD (ISO)</option>
          <option value="dmy">DD/MM/YYYY</option>
          <option value="mdy">MM/DD/YYYY (US)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Zona Waktu</label>
        <select id="cfg-timezone" onchange="saveDateSettings()">
          <option value="Asia/Jakarta">WIB ‚Äî Jakarta (UTC+7)</option>
          <option value="Asia/Makassar">WITA ‚Äî Makassar (UTC+8)</option>
          <option value="Asia/Jayapura">WIT ‚Äî Jayapura (UTC+9)</option>
          <option value="Asia/Singapore">SGT ‚Äî Singapura (UTC+8)</option>
          <option value="UTC">UTC (UTC+0)</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Auto-isi Tanggal Saat Buka Form</label>
      <select id="cfg-autodate" onchange="saveDateSettings()">
        <option value="today">Hari ini (otomatis)</option>
        <option value="yesterday">Kemarin</option>
        <option value="manual">Manual (kosong)</option>
      </select>
    </div>
    <div style="background:var(--faint);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:4px">
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px">Preview Format</div>
      <div style="font-size:15px;font-weight:600;color:var(--primary)" id="date-preview"></div>
      <div style="font-size:11px;color:var(--sub);margin-top:4px" id="date-tz-info"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card mb16">
      <div class="card-title">Google Sheets URL</div>
      <div class="form-group">
        <label class="form-label">URL Apps Script</label>
        <input type="text" id="cfg-url" placeholder="https://script.google.com/macros/s/.../exec">
      </div>
      <button class="btn btn-primary btn-sm" onclick="saveConfig()">Simpan & Reload</button>
    </div>
    <div class="card mb16">
      <div class="card-title">Preferensi</div>
      <div class="form-group">
        <label class="form-label">Nama Pengguna</label>
        <input type="text" id="cfg-name" placeholder="Nama kamu">
      </div>
      <div class="form-group">
        <label class="form-label">Mata Uang</label>
        <select id="cfg-currency">
          <option value="IDR">IDR ‚Äî Rupiah</option>
          <option value="USD">USD ‚Äî Dollar</option>
          <option value="SGD">SGD ‚Äî Singapore Dollar</option>
          <option value="MYR">MYR ‚Äî Ringgit</option>
        </select>
      </div>
      <button class="btn btn-primary btn-sm" onclick="savePref()">Simpan</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Konversi Mata Uang (estimasi)</div>
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div class="form-group" style="margin-bottom:0;flex:1;min-width:120px">
        <label class="form-label">Jumlah</label>
        <input type="number" id="conv-amount" placeholder="1000000" oninput="calcConversion()">
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">Dari</label>
        <select id="conv-from" onchange="calcConversion()" style="width:100px">
          <option value="IDR">IDR</option><option value="USD">USD</option><option value="SGD">SGD</option><option value="MYR">MYR</option><option value="EUR">EUR</option><option value="JPY">JPY</option>
        </select>
      </div>
      <div style="padding-bottom:10px;font-size:18px;color:var(--sub)">‚Üí</div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">Ke</label>
        <select id="conv-to" onchange="calcConversion()" style="width:100px">
          <option value="USD">USD</option><option value="IDR" selected>IDR</option><option value="SGD">SGD</option><option value="MYR">MYR</option><option value="EUR">EUR</option><option value="JPY">JPY</option>
        </select>
      </div>
    </div>
    <div id="conv-result" style="margin-top:12px;font-size:16px;font-weight:700;color:var(--primary)"></div>
    <div style="font-size:11px;color:var(--sub);margin-top:4px">* Kurs perkiraan, bukan kurs real-time</div>
  </div>
</div>

<!-- ======= KAS / CASH ======= -->
<div id="cash" class="section">
  <div class="topbar">
    <div class="page-title">üíµ Kas Usaha</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="exportCashCSV()">üì§ Export</button>
      <button class="btn btn-primary btn-sm" onclick="openCashModal('setoran')">+ Setoran Masuk</button>
    </div>
  </div>

  <!-- Stat cards -->
  <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px">
    <div class="stat-card" style="border-top:3px solid #CA8A04">
      <span class="stat-icon">üí∞</span>
      <div class="stat-label">Saldo Kas</div>
      <div class="stat-value" id="kas-saldo" style="color:#CA8A04">‚Äî</div>
      <div class="stat-change text-sub" id="kas-saldo-sub"></div>
    </div>
    <div class="stat-card stat-income">
      <span class="stat-icon">üì•</span>
      <div class="stat-label">Total Setoran</div>
      <div class="stat-value text-green" id="kas-masuk">‚Äî</div>
      <div class="stat-change text-sub" id="kas-masuk-sub"></div>
    </div>
    <div class="stat-card stat-expense">
      <span class="stat-icon">üì§</span>
      <div class="stat-label">Total Pengeluaran</div>
      <div class="stat-value text-red" id="kas-keluar">‚Äî</div>
      <div class="stat-change text-sub" id="kas-keluar-sub"></div>
    </div>
    <div class="stat-card" style="border-top:3px solid #7C3AED">
      <span class="stat-icon">üìã</span>
      <div class="stat-label">Tagihan Belum Bayar</div>
      <div class="stat-value" id="kas-piutang" style="color:#7C3AED">‚Äî</div>
      <div class="stat-change text-sub" id="kas-piutang-sub"></div>
    </div>
  </div>

  <!-- Tabs -->
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
    <button class="btn btn-primary btn-sm" id="kastab-transaksi" onclick="showKasTab('transaksi',this)">üìã Transaksi Kas</button>
    <button class="btn btn-ghost btn-sm" id="kastab-piutang" onclick="showKasTab('piutang',this)">üìí Tagihan & Hutang</button>
    <button class="btn btn-ghost btn-sm" id="kastab-rekap" onclick="showKasTab('rekap',this)">üìä Rekap</button>
    <button class="btn btn-ghost btn-sm" id="kastab-pecahan" onclick="showKasTab('pecahan',this)">üè∑Ô∏è Hitung Pecahan</button>
  </div>

  <!-- TAB: Transaksi Kas -->
  <div id="kastab-content-transaksi">
    <div class="card mb16">
      <div class="flex-between" style="margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">Riwayat Transaksi Kas</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
          <select id="kas-month-filter" onchange="renderKasHistory()" style="font-size:12px;padding:5px 8px">
            <option value="">Semua Bulan</option>
          </select>
          <span class="pill active" onclick="setKasType('all',this)">Semua</span>
          <span class="pill" onclick="setKasType('setoran',this)">üì• Setoran</span>
          <span class="pill" onclick="setKasType('keluar',this)">üì§ Keluar</span>
          <span class="pill" onclick="setKasType('transfer',this)">üîÑ Transfer</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div class="search-bar" style="flex:1">
          <span class="search-icon">üîç</span>
          <input type="text" id="kas-search" placeholder="Cari nama/keterangan..." oninput="renderKasHistory()">
        </div>
      </div>
      <div id="kas-summary-bar" style="display:flex;gap:16px;padding:10px;background:var(--faint);border-radius:8px;margin-bottom:12px;flex-wrap:wrap"></div>
      <div id="kas-history-list"></div>
    </div>

    <!-- Quick action buttons -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
      <button class="btn btn-primary" onclick="openCashModal('setoran')">üì• Setoran Masuk</button>
      <button class="btn btn-ghost" onclick="openCashModal('keluar')">üì§ Pengeluaran</button>
      <button class="btn btn-ghost" onclick="openCashModal('transfer')">üîÑ Transfer Dompet</button>
    </div>

    <!-- Dompet cards -->
    <div class="card">
      <div class="flex-between" style="margin-bottom:14px">
        <div class="card-title" style="margin-bottom:0">üóÇÔ∏è Dompet Kas</div>
        <button class="btn btn-ghost btn-xs" onclick="openModal('addWallet')">+ Tambah Dompet</button>
      </div>
      <div id="kas-wallets"></div>
    </div>
  </div>

  <!-- TAB: Tagihan & Hutang -->
  <div id="kastab-content-piutang" style="display:none">
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="openModal('addPiutang')">+ Tagihan Pelanggan Belum Bayar</button>
      <button class="btn btn-ghost" onclick="openModal('addHutang')">+ Catat Hutang Saya</button>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title" style="color:var(--primary)">üìã Tagihan Belum Dibayar Pelanggan</div>
        <div style="font-size:11px;color:var(--sub);margin-bottom:12px">Pelanggan yang belum bayar setoran (paket internet, dll)</div>
        <div id="list-piutang"></div>
        <div id="total-piutang" style="border-top:1px solid var(--border);padding-top:10px;margin-top:10px;font-weight:700;font-size:13px"></div>
      </div>
      <div class="card">
        <div class="card-title" style="color:var(--red)">üî¥ Hutang Saya</div>
        <div style="font-size:11px;color:var(--sub);margin-bottom:12px">Uang yang kamu pinjam dari orang lain</div>
        <div id="list-hutang"></div>
        <div id="total-hutang" style="border-top:1px solid var(--border);padding-top:10px;margin-top:10px;font-weight:700;font-size:13px"></div>
      </div>
    </div>

    <!-- Riwayat pelunasan -->
    <div class="card" style="margin-top:16px">
      <div class="card-title">üìú Riwayat Pembayaran</div>
      <div id="list-pelunasan"></div>
    </div>
  </div>

  <!-- TAB: Rekap -->
  <div id="kastab-content-rekap" style="display:none">
    <div class="grid-2 mb16">
      <div class="card">
        <div class="card-title">üìÖ Rekap Harian (30 hari terakhir)</div>
        <div id="kas-rekap-harian"></div>
      </div>
      <div class="card">
        <div class="card-title">üìÜ Rekap Bulanan</div>
        <div id="kas-rekap-bulanan"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üè∑Ô∏è Pengeluaran per Kategori</div>
      <div id="kas-rekap-kategori"></div>
    </div>
  </div>

  <!-- TAB: Pecahan -->
  <div id="kastab-content-pecahan" style="display:none">
    <div class="card" style="max-width:480px">
      <div class="flex-between" style="margin-bottom:14px">
        <div class="card-title" style="margin-bottom:0">üè∑Ô∏è Hitung Pecahan Uang</div>
        <button class="btn btn-ghost btn-xs" onclick="resetDenomination()">Reset</button>
      </div>
      <div id="denomination-list"></div>
      <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px" id="denomination-total"></div>
    </div>
  </div>
</div>

</div><!-- end main -->
</div><!-- end app -->

<!-- ======= MODALS ======= -->
<!-- Add Transaction -->
<div class="modal-overlay" id="modal-addTx">
  <div class="modal">
    <div class="modal-title">Catat Transaksi <button class="modal-close" onclick="closeModal('addTx')">√ó</button></div>
    <div class="type-tabs">
      <button class="type-tab expense" id="tab-expense" onclick="setFormType('expense')">‚ù§Ô∏è Pengeluaran</button>
      <button class="type-tab" id="tab-income" onclick="setFormType('income')">üíö Pemasukan</button>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Kategori</label><select id="f-cat"></select></div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="f-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tanggal</label><input type="date" id="f-date"></div>
      <div class="form-group"><label class="form-label">Tag (opsional)</label><input type="text" id="f-tag" placeholder="misal: #bulanan"></div>
    </div>
    <div class="form-group"><label class="form-label">Catatan</label><input type="text" id="f-note" placeholder="Keterangan..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addTx')">Batal</button>
      <button class="btn btn-primary" onclick="addTransaction()" id="saveBtn">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Add Budget -->
<div class="modal-overlay" id="modal-addBudget">
  <div class="modal">
    <div class="modal-title">Atur Anggaran <button class="modal-close" onclick="closeModal('addBudget')">√ó</button></div>
    <div class="form-group"><label class="form-label">Kategori</label>
      <select id="b-cat"><option>Makanan</option><option>Transport</option><option>Belanja</option><option>Hiburan</option><option>Kesehatan</option><option>Pendidikan</option><option>Tagihan</option><option>Lainnya</option></select>
    </div>
    <div class="form-group"><label class="form-label">Batas Bulanan (Rp)</label><input type="number" id="b-amount" placeholder="500000"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addBudget')">Batal</button>
      <button class="btn btn-primary" onclick="saveBudget()">Simpan</button>
    </div>
  </div>
</div>

<!-- Add Goal -->
<div class="modal-overlay" id="modal-addGoal">
  <div class="modal">
    <div class="modal-title">Target Tabungan Baru <button class="modal-close" onclick="closeModal('addGoal')">√ó</button></div>
    <div class="form-group"><label class="form-label">Nama Target</label><input type="text" id="g-name" placeholder="misal: Beli Laptop"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Target (Rp)</label><input type="number" id="g-target" placeholder="5000000"></div>
      <div class="form-group"><label class="form-label">Terkumpul (Rp)</label><input type="number" id="g-current" placeholder="0"></div>
    </div>
    <div class="form-group"><label class="form-label">Deadline</label><input type="date" id="g-deadline"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addGoal')">Batal</button>
      <button class="btn btn-primary" onclick="saveGoal()">Simpan</button>
    </div>
  </div>
</div>

<!-- Edit Transaction -->
<div class="modal-overlay" id="modal-editTx">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Ubah Transaksi <button class="modal-close" onclick="closeModal('editTx')">√ó</button></div>
    <input type="hidden" id="e-id">
    <div class="type-tabs">
      <button class="type-tab expense" id="etab-expense" onclick="setEditType('expense')">‚ù§Ô∏è Pengeluaran</button>
      <button class="type-tab" id="etab-income" onclick="setEditType('income')">üíö Pemasukan</button>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Kategori</label><select id="e-cat"></select></div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="e-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tanggal</label><input type="date" id="e-date"></div>
      <div class="form-group"><label class="form-label">Tag</label><input type="text" id="e-tag" placeholder="#bulanan"></div>
    </div>
    <div class="form-group"><label class="form-label">Catatan</label><input type="text" id="e-note" placeholder="Keterangan..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('editTx')">Batal</button>
      <button class="btn btn-primary" onclick="updateTransaction()" id="updateBtn">üíæ Simpan Perubahan</button>
    </div>
  </div>
</div>

<!-- Add Recurring -->
<div class="modal-overlay" id="modal-addRecurring">
  <div class="modal">
    <div class="modal-title">Transaksi Rutin Baru <button class="modal-close" onclick="closeModal('addRecurring')">√ó</button></div>
    <div class="form-group"><label class="form-label">Nama</label><input type="text" id="r-name" placeholder="misal: Netflix, Listrik"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Kategori</label><select id="r-cat"><option>Tagihan</option><option>Makanan</option><option>Transport</option><option>Hiburan</option><option>Kesehatan</option><option>Pendidikan</option><option>Lainnya</option></select></div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="r-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Frekuensi</label>
        <select id="r-freq" onchange="toggleDueField('r')">
          <option value="monthly">Bulanan</option>
          <option value="weekly">Mingguan</option>
          <option value="yearly">Tahunan</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Tipe</label>
        <select id="r-type"><option value="expense">Pengeluaran</option><option value="income">Pemasukan</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" id="r-due-wrap"><label class="form-label" id="r-due-label">Tanggal Jatuh Tempo (hari ke-)</label>
        <select id="r-due">
          <option value="">-- Pilih tanggal --</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
          <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
          <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
          <option value="26">26</option><option value="27">27</option><option value="28">28</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Jam Jatuh Tempo</label>
        <input type="time" id="r-time" value="09:00">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ingatkan (H-berapa sebelum jatuh tempo)</label>
      <select id="r-reminder">
        <option value="">Tidak ada pengingat</option>
        <option value="1">H-1 (sehari sebelum)</option>
        <option value="3">H-3 (3 hari sebelum)</option>
        <option value="5">H-5 (5 hari sebelum)</option>
        <option value="7">H-7 (seminggu sebelum)</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Catatan</label><input type="text" id="r-note" placeholder="Opsional..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addRecurring')">Batal</button>
      <button class="btn btn-primary" onclick="saveRecurring()">Simpan</button>
    </div>
  </div>
</div>

<!-- Edit Recurring -->
<div class="modal-overlay" id="modal-editRecurring">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Ubah Transaksi Rutin <button class="modal-close" onclick="closeModal('editRecurring')">√ó</button></div>
    <input type="hidden" id="er-id">
    <div class="form-group"><label class="form-label">Nama</label><input type="text" id="er-name" placeholder="misal: Netflix, Listrik"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Kategori</label>
        <select id="er-cat"><option>Tagihan</option><option>Makanan</option><option>Transport</option><option>Hiburan</option><option>Kesehatan</option><option>Pendidikan</option><option>Lainnya</option></select>
      </div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="er-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Frekuensi</label>
        <select id="er-freq" onchange="toggleDueField('er')">
          <option value="monthly">Bulanan</option>
          <option value="weekly">Mingguan</option>
          <option value="yearly">Tahunan</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Tipe</label>
        <select id="er-type"><option value="expense">Pengeluaran</option><option value="income">Pemasukan</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" id="er-due-wrap"><label class="form-label" id="er-due-label">Tanggal Jatuh Tempo (hari ke-)</label>
        <select id="er-due">
          <option value="">-- Pilih tanggal --</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
          <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
          <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
          <option value="26">26</option><option value="27">27</option><option value="28">28</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Jam Jatuh Tempo</label>
        <input type="time" id="er-time" value="09:00">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ingatkan (H-berapa sebelum jatuh tempo)</label>
      <select id="er-reminder">
        <option value="">Tidak ada pengingat</option>
        <option value="1">H-1 (sehari sebelum)</option>
        <option value="3">H-3 (3 hari sebelum)</option>
        <option value="5">H-5 (5 hari sebelum)</option>
        <option value="7">H-7 (seminggu sebelum)</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Catatan</label><input type="text" id="er-note" placeholder="Opsional..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('editRecurring')">Batal</button>
      <button class="btn btn-primary" onclick="updateRecurring()">üíæ Simpan Perubahan</button>
    </div>
  </div>
</div>

<!-- Catat Kas (Setoran/Keluar/Transfer) -->
<div class="modal-overlay" id="modal-addCash">
  <div class="modal">
    <div class="modal-title" id="addCash-title">üì• Setoran Masuk <button class="modal-close" onclick="closeModal('addCash')">√ó</button></div>
    <div class="type-tabs" id="addCash-tabs">
      <button class="type-tab income" id="ctab-setoran" onclick="setCashFormType('setoran')">üì• Setoran</button>
      <button class="type-tab" id="ctab-keluar" onclick="setCashFormType('keluar')">üì§ Keluar</button>
      <button class="type-tab" id="ctab-transfer" onclick="setCashFormType('transfer')">üîÑ Transfer</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nama / Pelanggan</label>
        <input type="text" id="c-nama" placeholder="misal: Budi, Toko Maju, dll">
      </div>
      <div class="form-group">
        <label class="form-label">Jumlah (Rp)</label>
        <input type="number" id="c-amount" placeholder="0">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" id="c-wallet-wrap">
        <label class="form-label" id="cash-wallet-label">Dari Dompet</label>
        <select id="c-wallet"></select>
      </div>
      <div class="form-group" id="c-to-wrap" style="display:none">
        <label class="form-label">Ke Dompet</label>
        <select id="c-wallet-to"></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Kategori</label>
        <select id="c-cat">
          <option value="Paket Internet">üì∂ Paket Internet</option>
          <option value="Tagihan">‚ö° Tagihan</option>
          <option value="Makanan">üçú Makanan</option>
          <option value="Transport">üöó Transport</option>
          <option value="Belanja">üõçÔ∏è Belanja</option>
          <option value="Gaji">üíº Gaji</option>
          <option value="Operasional">‚öôÔ∏è Operasional</option>
          <option value="Lainnya">üìå Lainnya</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Tanggal</label>
        <input type="date" id="c-date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Keterangan</label>
      <input type="text" id="c-note" placeholder="Keterangan tambahan...">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addCash')">Batal</button>
      <button class="btn btn-primary" onclick="addCashTransaction()">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Edit Kas -->
<div class="modal-overlay" id="modal-editCash">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Ubah Transaksi Kas <button class="modal-close" onclick="closeModal('editCash')">√ó</button></div>
    <input type="hidden" id="ec-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nama / Pelanggan</label><input type="text" id="ec-nama" placeholder="Nama..."></div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="ec-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Kategori</label>
        <select id="ec-cat">
          <option>Paket Internet</option><option>Tagihan</option><option>Makanan</option>
          <option>Transport</option><option>Belanja</option><option>Gaji</option>
          <option>Operasional</option><option>Lainnya</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Tanggal</label><input type="date" id="ec-date"></div>
    </div>
    <div class="form-group"><label class="form-label">Keterangan</label><input type="text" id="ec-note"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('editCash')">Batal</button>
      <button class="btn btn-primary" onclick="updateCashTransaction()">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Tambah Tagihan Pelanggan -->
<div class="modal-overlay" id="modal-addPiutang">
  <div class="modal">
    <div class="modal-title">üìã Tagihan Pelanggan Belum Bayar <button class="modal-close" onclick="closeModal('addPiutang')">√ó</button></div>
    <div style="font-size:12px;color:var(--sub);margin-bottom:12px">Catat pelanggan yang belum bayar setoran (paket internet, dll)</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nama Pelanggan</label><input type="text" id="p-nama" placeholder="Nama pelanggan"></div>
      <div class="form-group"><label class="form-label">Jumlah Tagihan (Rp)</label><input type="number" id="p-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tanggal Tagihan</label><input type="date" id="p-date"></div>
      <div class="form-group"><label class="form-label">Jatuh Tempo (opsional)</label><input type="date" id="p-due"></div>
    </div>
    <div class="form-group"><label class="form-label">Keterangan</label><input type="text" id="p-note" placeholder="misal: Paket 20Mbps bulan Maret"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addPiutang')">Batal</button>
      <button class="btn btn-primary" onclick="savePiutang()">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Tambah Hutang -->
<div class="modal-overlay" id="modal-addHutang">
  <div class="modal">
    <div class="modal-title">üî¥ Catat Hutang (Kamu Pinjam) <button class="modal-close" onclick="closeModal('addHutang')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nama Pemberi Hutang</label><input type="text" id="h-nama" placeholder="Nama orang/bank"></div>
      <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="h-amount" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tanggal Pinjam</label><input type="date" id="h-date"></div>
      <div class="form-group"><label class="form-label">Jatuh Tempo (opsional)</label><input type="date" id="h-due"></div>
    </div>
    <div class="form-group"><label class="form-label">Keterangan</label><input type="text" id="h-note" placeholder="Keperluan..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addHutang')">Batal</button>
      <button class="btn btn-primary" onclick="saveHutang()">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Bayar / Lunasi -->
<div class="modal-overlay" id="modal-lunasiDebt">
  <div class="modal">
    <div class="modal-title" id="lunasi-title">‚úÖ Lunasi <button class="modal-close" onclick="closeModal('lunasiDebt')">√ó</button></div>
    <input type="hidden" id="lunasi-id">
    <input type="hidden" id="lunasi-type">
    <div id="lunasi-info" style="background:var(--faint);padding:12px;border-radius:8px;margin-bottom:14px;font-size:13px"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Jumlah Bayar (Rp)</label><input type="number" id="lunasi-amount" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Tanggal Bayar</label><input type="date" id="lunasi-date"></div>
    </div>
    <div class="form-group"><label class="form-label">Keterangan</label><input type="text" id="lunasi-note" placeholder="Opsional..."></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('lunasiDebt')">Batal</button>
      <button class="btn btn-primary" onclick="lunasiDebt()">‚úÖ Tandai Lunas</button>
    </div>
  </div>
</div>

<!-- Tambah Dompet -->
<div class="modal-overlay" id="modal-addWallet">
  <div class="modal">
    <div class="modal-title">üóÇÔ∏è Tambah Dompet Kas <button class="modal-close" onclick="closeModal('addWallet')">√ó</button></div>
    <div class="form-group"><label class="form-label">Nama</label>
      <input type="text" id="w-name" placeholder="misal: Dompet Harian, Brankas, Celengan">
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Saldo Awal (Rp)</label><input type="number" id="w-balance" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Warna</label>
        <select id="w-color">
          <option value="#CA8A04">üü° Emas</option>
          <option value="#16A34A">üü¢ Hijau</option>
          <option value="#2563EB">üîµ Biru</option>
          <option value="#DC2626">üî¥ Merah</option>
          <option value="#7C3AED">üü£ Ungu</option>
          <option value="#6B7280">‚ö´ Abu-abu</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('addWallet')">Batal</button>
      <button class="btn btn-primary" onclick="saveWallet()">Simpan</button>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIG
// ============================================
let API_URL = localStorage.getItem('dompet_url') || "https://script.google.com/macros/s/AKfycbyr5Qatt5xQ1_LgLfXRXyo1uM93xiNfT5x7Qx3dnHYGseNd-XkNhG5nq3Rd6-_OOTNs/exec";
let CURRENCY = localStorage.getItem('dompet_currency') || 'IDR';
let USER_NAME = localStorage.getItem('dompet_name') || '';

const CATS = {
  income: ["Gaji","Freelance","Investasi","Bisnis","Bonus","Lainnya"],
  expense: ["Makanan","Transport","Belanja","Hiburan","Kesehatan","Pendidikan","Tagihan","Lainnya"]
};
const CAT_COLOR = {
  Makanan:"#DC2626",Transport:"#2563EB",Belanja:"#D97706",Hiburan:"#7C3AED",
  Kesehatan:"#059669",Pendidikan:"#0891B2",Tagihan:"#EA580C",Lainnya:"#6B7280",
  Gaji:"#16A34A",Freelance:"#2563EB",Investasi:"#D97706",Bisnis:"#7C3AED",Bonus:"#059669"
};
const CAT_ICON = {
  Makanan:"üçú",Transport:"üöó",Belanja:"üõçÔ∏è",Hiburan:"üé¨",Kesehatan:"üíä",
  Pendidikan:"üìö",Tagihan:"‚ö°",Lainnya:"üìå",Gaji:"üíº",Freelance:"üíª",
  Investasi:"üìà",Bisnis:"üè¢",Bonus:"üéÅ"
};
const RATES = {IDR:1,USD:16000,SGD:12000,MYR:3500,EUR:17500,JPY:107};

let transactions = [];
let budgets = JSON.parse(localStorage.getItem('dompet_budgets')||'{}');
let goals = JSON.parse(localStorage.getItem('dompet_goals')||'[]');
let recurring = JSON.parse(localStorage.getItem('dompet_recurring')||'[]');
let chatHistory = [];
let formType = 'expense';
let h_month = localStorage.getItem('dompet_h_month') || 'all';
let h_type  = localStorage.getItem('dompet_h_type')  || 'all';

// Cash management data
let wallets = JSON.parse(localStorage.getItem('dompet_wallets')||'[]');
let cashTx = JSON.parse(localStorage.getItem('dompet_cash')||'[]');
let piutangList = JSON.parse(localStorage.getItem('dompet_piutang')||'[]');
let hutangList = JSON.parse(localStorage.getItem('dompet_hutang')||'[]');
let pelunasanList = JSON.parse(localStorage.getItem('dompet_pelunasan')||'[]');
let cashFormType = 'setoran';
let kasTypeFilter = 'all';
let kasTab = 'transaksi';

// Default denomination denominations (IDR)
const DENOMINATIONS = [100000,50000,20000,10000,5000,2000,1000,500,200,100];
let denomCounts = JSON.parse(localStorage.getItem('dompet_denom')||'{}');

// Date & theme config (needed by helpers below)
let DATE_FMT  = localStorage.getItem('dompet_datefmt') || 'id';
let DATE_TZ   = localStorage.getItem('dompet_tz') || 'Asia/Jakarta';
let DATE_AUTO = localStorage.getItem('dompet_autodate') || 'today';
let ACTIVE_THEME = localStorage.getItem('dompet_theme') || 'light';

// ============================================
// HELPERS
// ============================================
const rp = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:CURRENCY,minimumFractionDigits:0}).format(Number(n)||0);

function todayInTZ() {
  return new Date().toLocaleDateString('en-CA', {timeZone: DATE_TZ});
}
function formatDateDisplay(dateStr) {
  if (!dateStr) return '‚Äî';
  const normalized = normalizeDate(String(dateStr));
  if (!normalized) return '‚Äî';
  try {
    const d = new Date(normalized + 'T12:00:00');
    if (isNaN(d)) return '‚Äî';
    if (DATE_FMT === 'id') return d.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
    if (DATE_FMT === 'iso') return normalized;
    if (DATE_FMT === 'dmy') { const [y,m,dy]=normalized.split('-'); return `${dy}/${m}/${y}`; }
    if (DATE_FMT === 'mdy') { const [y,m,dy]=normalized.split('-'); return `${m}/${dy}/${y}`; }
    return d.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
  } catch(e) { return '‚Äî'; }
}
function autoDateValue() {
  if (DATE_AUTO === 'manual') return '';
  if (DATE_AUTO === 'yesterday') {
    const d = new Date(todayInTZ() + 'T12:00:00'); d.setDate(d.getDate()-1);
    return d.toISOString().split('T')[0];
  }
  return todayInTZ();
}

const fmtDate = d => formatDateDisplay(d);
const monthKey = d => {
  if(!d) return '';
  const s = normalizeDate(String(d));
  if(!s) return '';
  try { const dt=new Date(s+'T12:00:00'); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; } catch(e){return '';}
};
const monthLabel = k => {try{const[y,m]=k.split('-');return new Date(y,m-1).toLocaleDateString('id-ID',{month:'long',year:'numeric'})}catch(e){return k}};
const today = () => todayInTZ();
const nowMonthKey = () => monthKey(today());

function setSyncStatus(state,text){
  const dot=document.getElementById('syncDot');
  const lbl=document.getElementById('syncText');
  dot.className='sync-dot sync-'+state;
  lbl.textContent=text;
}
function showToast(msg,type='ok'){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div');
  t.className=`toast toast-${type}`;t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}

// Normalize tanggal dari berbagai format ‚Üí YYYY-MM-DD
function normalizeDate(raw) {
  if (raw === null || raw === undefined || raw === '') return '';
  const s = String(raw).trim();
  if (!s || s === 'null' || s === 'undefined') return '';

  // Sudah YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // ISO dengan waktu: 2026-02-27T00:00:00.000Z
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.substring(0, 10);

  // DD/MM/YYYY atau D/M/YYYY (format Indonesia)
  const slashParts = s.split('/');
  if (slashParts.length === 3) {
    const [a, b, c] = slashParts.map(x => x.trim());
    if (c.length === 4) {
      // Jika a > 12 pasti hari
      if (parseInt(a) > 12) return `${c}-${b.padStart(2,'0')}-${a.padStart(2,'0')}`;
      // Jika b > 12 pasti bulan (MM/DD)
      if (parseInt(b) > 12) return `${c}-${a.padStart(2,'0')}-${b.padStart(2,'0')}`;
      // Default: DD/MM/YYYY
      return `${c}-${b.padStart(2,'0')}-${a.padStart(2,'0')}`;
    }
    if (a.length === 4) return `${a}-${b.padStart(2,'0')}-${c.padStart(2,'0')}`;
  }

  // DD-MM-YYYY
  if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(s)) {
    const [d,m,y] = s.split('-');
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }

  // Google Sheets serial number (misal: 45700)
  if (/^\d{5}$/.test(s)) {
    const d = new Date(Math.round((parseInt(s) - 25569) * 86400 * 1000));
    if (!isNaN(d)) return d.toLocaleDateString('en-CA');
  }

  // Nama bulan Indonesia: "27 Februari 2026"
  const bulanID = {januari:'01',februari:'02',maret:'03',april:'04',mei:'05',juni:'06',juli:'07',agustus:'08',september:'09',oktober:'10',november:'11',desember:'12'};
  const m1 = s.toLowerCase().match(/(\d{1,2})\s+([a-z]+)\s+(\d{4})/);
  if (m1 && bulanID[m1[2]]) return `${m1[3]}-${bulanID[m1[2]]}-${m1[1].padStart(2,'0')}`;

  // Nama bulan Inggris: "Feb 27, 2026" atau "27 Feb 2026"
  const bulanEN = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
  const m2 = s.toLowerCase().match(/(\w{3})\s+(\d{1,2}),?\s+(\d{4})/);
  if (m2 && bulanEN[m2[1]]) return `${m2[3]}-${bulanEN[m2[1]]}-${m2[2].padStart(2,'0')}`;
  const m3 = s.toLowerCase().match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
  if (m3 && bulanEN[m3[2]]) return `${m3[3]}-${bulanEN[m3[2]]}-${m3[1].padStart(2,'0')}`;

  // Last resort: JS Date parse
  try {
    const d = new Date(s);
    if (!isNaN(d) && d.getFullYear() > 1970) return d.toLocaleDateString('en-CA');
  } catch(e) {}

  return '';
}

// ============================================
// DATA
// ============================================
async function loadData(){
  setSyncStatus('loading','Memuat...');
  try{
    const res=await fetch(API_URL+'?t='+Date.now());
    const json=await res.json();
    if(json.status==='ok'){
      transactions=json.data.map(t=>({
        ...t,
        amount:Number(t.amount),
        date: normalizeDate(t.date)
      }));
      setSyncStatus('ok','Tersinkron ‚úì');
      // Restore filter setelah data ada
      restoreHistoryFilters();
      renderAll();
    } else throw new Error(json.message||'Error');
  } catch(e){
    setSyncStatus('err','Gagal ‚úó');
    showToast('Gagal memuat: '+e.message,'err');
  }
}

// Restore semua filter history dari localStorage setelah data dimuat
function restoreHistoryFilters(){
  h_month = localStorage.getItem('dompet_h_month') || 'all';
  h_type  = localStorage.getItem('dompet_h_type')  || 'all';
  // Validasi: bulan yang disimpan harus ada di data
  const months = [...new Set(transactions.map(t=>monthKey(t.date)).filter(Boolean))];
  if(h_month !== 'all' && !months.includes(h_month)) h_month = 'all';
}

function renderAll(){
  renderDashboard();renderHistory();renderBudget();
  renderGoals();renderRecurring();renderReports();renderInsights();
}

// ============================================
// FORM
// ============================================
function openModal(id){
  document.getElementById('modal-'+id).classList.add('show');
  if(id==='addTx'){
    document.getElementById('f-date').value=autoDateValue();
    updateFormCats();
  }
}
function closeModal(id){document.getElementById('modal-'+id).classList.remove('show');}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show')})});

function setFormType(type){
  formType=type;
  document.getElementById('tab-expense').className='type-tab'+(type==='expense'?' expense':'');
  document.getElementById('tab-income').className='type-tab'+(type==='income'?' income':'');
  updateFormCats();
}
function updateFormCats(){
  document.getElementById('f-cat').innerHTML=CATS[formType].map(c=>`<option>${c}</option>`).join('');
}

async function addTransaction(){
  const amt=parseFloat(document.getElementById('f-amount').value);
  const date=document.getElementById('f-date').value;
  if(!amt||!date){showToast('Isi jumlah dan tanggal!','err');return;}
  const tx={
    id:Date.now(),type:formType,
    category:document.getElementById('f-cat').value,
    amount:amt,
    note:document.getElementById('f-note').value||'',
    tag:document.getElementById('f-tag').value||'',
    date
  };
  const btn=document.getElementById('saveBtn');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Menyimpan...';
  try{
    const res=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'add',...tx})});
    const json=await res.json();
    if(json.status==='ok'){
      transactions.push(tx);
      showToast('‚úì Tersimpan ke Google Sheets!');
      closeModal('addTx');
      document.getElementById('f-amount').value='';
      document.getElementById('f-note').value='';
      document.getElementById('f-tag').value='';
      // Auto-set filter ke bulan transaksi yang baru dicatat
      const txMonth = monthKey(tx.date);
      if(txMonth) {
        h_month = txMonth;
        localStorage.setItem('dompet_h_month', txMonth);
      }
      renderAll();
    } else throw new Error(json.message);
  } catch(e){showToast('Gagal simpan: '+e.message,'err');}
  btn.disabled=false;btn.textContent='üíæ Simpan';
}

async function deleteTransaction(id){
  if(!confirm('Hapus transaksi ini?'))return;
  try{
    const res=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'delete',id:String(id)})});
    const json=await res.json();
    if(json.status==='ok'){
      transactions=transactions.filter(t=>String(t.id)!==String(id));
      showToast('‚úì Dihapus');renderAll();
    } else throw new Error(json.message);
  } catch(e){showToast('Gagal hapus: '+e.message,'err');}
}

let editType = 'expense';

function openEditModal(id) {
  const t = transactions.find(tx => String(tx.id) === String(id));
  if (!t) return;
  editType = t.type;
  document.getElementById('e-id').value = t.id;
  document.getElementById('e-amount').value = t.amount;
  document.getElementById('e-date').value = t.date;
  document.getElementById('e-note').value = t.note || '';
  document.getElementById('e-tag').value = t.tag || '';
  // set type tabs
  document.getElementById('etab-expense').className = 'type-tab' + (editType==='expense'?' expense':'');
  document.getElementById('etab-income').className  = 'type-tab' + (editType==='income'?' income':'');
  // populate category options & select current
  const catSel = document.getElementById('e-cat');
  catSel.innerHTML = CATS[editType].map(c=>`<option ${c===t.category?'selected':''}>${c}</option>`).join('');
  catSel.value = t.category;
  document.getElementById('modal-editTx').classList.add('show');
}

function setEditType(type) {
  editType = type;
  document.getElementById('etab-expense').className = 'type-tab' + (type==='expense'?' expense':'');
  document.getElementById('etab-income').className  = 'type-tab' + (type==='income'?' income':'');
  const catSel = document.getElementById('e-cat');
  const cur = catSel.value;
  catSel.innerHTML = CATS[type].map(c=>`<option>${c}</option>`).join('');
  // keep selection if same cat exists
  if ([...catSel.options].some(o=>o.value===cur)) catSel.value = cur;
}

async function updateTransaction() {
  const id = document.getElementById('e-id').value;
  const amt = parseFloat(document.getElementById('e-amount').value);
  const date = document.getElementById('e-date').value;
  if (!amt || !date) { showToast('Isi jumlah dan tanggal!', 'err'); return; }

  const updated = {
    id,
    type: editType,
    category: document.getElementById('e-cat').value,
    amount: amt,
    note: document.getElementById('e-note').value || '',
    tag: document.getElementById('e-tag').value || '',
    date
  };

  const btn = document.getElementById('updateBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Menyimpan...';

  try {
    const res = await fetch(API_URL, {method:'POST', body: JSON.stringify({action:'update', ...updated})});
    const json = await res.json();
    if (json.status === 'ok') {
      // update local array
      const idx = transactions.findIndex(t => String(t.id) === String(id));
      if (idx !== -1) transactions[idx] = {...updated, amount: amt};
      showToast('‚úì Transaksi berhasil diubah!');
      closeModal('editTx');
      renderAll();
    } else throw new Error(json.message);
  } catch(e) { showToast('Gagal update: ' + e.message, 'err'); }
  btn.disabled = false; btn.textContent = 'üíæ Simpan Perubahan';
}

// ============================================
// DASHBOARD
// ============================================
function renderDashboard(){
  const income=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance=income-expense;
  const rate=income>0?Math.round((balance/income)*100):0;

  document.getElementById('s-balance').textContent=rp(balance);
  document.getElementById('s-balance').style.color=balance>=0?'var(--primary)':'var(--red)';
  document.getElementById('s-rate').innerHTML=`<span style="color:${rate>=20?'var(--green)':rate>0?'var(--yellow)':'var(--red)'}">${rate>=20?'‚úì Sehat':rate>0?'‚ö° Perlu ditingkatkan':'‚ö†Ô∏è Defisit'}</span>`;
  document.getElementById('s-income').textContent=rp(income);
  document.getElementById('s-income-count').textContent=transactions.filter(t=>t.type==='income').length+' transaksi';
  document.getElementById('s-expense').textContent=rp(expense);
  document.getElementById('s-expense-count').textContent=transactions.filter(t=>t.type==='expense').length+' transaksi';
  document.getElementById('s-saving').textContent=rate+'%';

  // Cat bar
  const bycat={};
  transactions.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount});
  const maxV=Math.max(...Object.values(bycat),1);
  document.getElementById('d-catbar').innerHTML=Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([c,v])=>`
    <div class="hbar">
      <div class="hbar-label">${CAT_ICON[c]||''} ${c}</div>
      <div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxV)*100}%;background:${CAT_COLOR[c]||'var(--primary)'}"></div></div>
      <div class="hbar-val">${rp(v)}</div>
    </div>`).join('')||'<div class="empty">Belum ada pengeluaran</div>';

  // Trend
  renderTrend();

  // Recent
  const recent=[...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6);
  document.getElementById('d-recent').innerHTML=recent.length?recent.map(txHTML).join(''):'<div class="empty">Belum ada transaksi</div>';

  // Budget dashboard
  const spent={};
  transactions.filter(t=>t.type==='expense'&&monthKey(t.date)===nowMonthKey()).forEach(t=>{spent[t.category]=(spent[t.category]||0)+t.amount});
  if(!Object.keys(budgets).length){document.getElementById('d-budget').innerHTML='<div class="empty">Belum ada anggaran. <a href="#" onclick="showPage(\'budget\',document.querySelectorAll(\'.nav-item\')[2]);return false" style="color:var(--primary)">Atur sekarang ‚Üí</a></div>';return;}
  document.getElementById('d-budget').innerHTML=Object.entries(budgets).slice(0,5).map(([cat,limit])=>{
    const used=spent[cat]||0;const pct=Math.min(Math.round((used/limit)*100),100);
    const col=pct>=100?'var(--red)':pct>=80?'var(--yellow)':'var(--green)';
    return `<div style="margin-bottom:10px">
      <div class="flex-between" style="margin-bottom:4px"><span style="font-size:12px;font-weight:600">${CAT_ICON[cat]||''} ${cat}</span><span style="font-size:11px;color:var(--sub)">${rp(used)}/${rp(limit)}</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${col}"></div></div>
    </div>`;
  }).join('');
}

function renderTrend(){
  const months=[];
  for(let i=5;i>=0;i--){const d=new Date();d.setMonth(d.getMonth()-i);months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);}
  const maxVal=Math.max(...months.flatMap(m=>{
    const inc=transactions.filter(t=>t.type==='income'&&monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
    const exp=transactions.filter(t=>t.type==='expense'&&monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
    return[inc,exp];
  }),1);
  const[,mo]=months[months.length-1].split('-');
  const mls=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'];
  document.getElementById('d-trend').innerHTML=months.map(m=>{
    const inc=transactions.filter(t=>t.type==='income'&&monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
    const exp=transactions.filter(t=>t.type==='expense'&&monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
    const ih=Math.max(Math.round((inc/maxVal)*56),2);
    const eh=Math.max(Math.round((exp/maxVal)*56),2);
    const[,mo2]=m.split('-');
    return `<div class="trend-col"><div class="trend-bars">
      <div class="tbar" style="height:${ih}px;background:var(--green);opacity:.7"></div>
      <div class="tbar" style="height:${eh}px;background:var(--red);opacity:.7"></div>
    </div><div class="trend-lbl">${mls[parseInt(mo2)-1]}</div></div>`;
  }).join('');
}

// ============================================
// HISTORY
// ============================================
function renderHistory(){
  const months=[...new Set(transactions.map(t=>monthKey(t.date)).filter(Boolean))].sort().reverse();

  document.getElementById('h-monthFilter').innerHTML=
    `<span class="pill ${h_month==='all'?'active':''}" onclick="setHMonth('all',this)">Semua</span>`+
    months.map(m=>`<span class="pill ${h_month===m?'active':''}" onclick="setHMonth('${m}',this)">${monthLabel(m)}</span>`).join('');

  // Update cat filter ‚Äî restore saved selection
  const savedCat = localStorage.getItem('dompet_h_cat') || '';
  const cats=[...new Set(transactions.map(t=>t.category))].sort();
  const catSel=document.getElementById('h-catFilter');
  catSel.innerHTML='<option value="">Semua Kategori</option>'+cats.map(c=>`<option value="${c}" ${c===savedCat?'selected':''}>${c}</option>`).join('');
  catSel.onchange = () => { localStorage.setItem('dompet_h_cat', catSel.value); renderHistory(); };

  // Restore saved search text
  const savedSearch = localStorage.getItem('dompet_h_search') || '';
  const searchEl = document.getElementById('h-search');
  if(searchEl && searchEl.value === '' && savedSearch) searchEl.value = savedSearch;
  searchEl.oninput = () => { localStorage.setItem('dompet_h_search', searchEl.value); renderHistory(); };

  // Restore tipe pill active state
  document.querySelectorAll('#history .pill[onclick^="setTxType"]').forEach(b => {
    const t = b.getAttribute('onclick').match(/'(\w+)'/)?.[1];
    b.classList.toggle('active', t === h_type);
  });

  const search = searchEl.value.toLowerCase();
  const catF   = catSel.value;
  let filtered=[...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(h_month!=='all') filtered=filtered.filter(t=>monthKey(t.date)===h_month);
  if(h_type!=='all')  filtered=filtered.filter(t=>t.type===h_type);
  if(catF)            filtered=filtered.filter(t=>t.category===catF);
  if(search)          filtered=filtered.filter(t=>(t.category+t.note+t.tag).toLowerCase().includes(search));

  const inc=filtered.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=filtered.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  document.getElementById('h-summary').innerHTML=`
    <span style="font-size:12px"><span style="font-weight:600;color:var(--green)">Masuk: ${rp(inc)}</span></span>
    <span style="font-size:12px"><span style="font-weight:600;color:var(--red)">Keluar: ${rp(exp)}</span></span>
    <span style="font-size:12px;color:var(--sub)">Saldo: <strong style="color:${inc-exp>=0?'var(--primary)':'var(--red)'}">${rp(inc-exp)}</strong></span>
    <span style="font-size:12px;color:var(--sub)">${filtered.length} transaksi</span>`;

  document.getElementById('h-list').innerHTML=filtered.length?filtered.map(txHTML).join(''):'<div class="empty">Tidak ada transaksi ditemukan</div>';
}

function setHMonth(m, btn){
  h_month = m;
  localStorage.setItem('dompet_h_month', m);
  document.querySelectorAll('#h-monthFilter .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderHistory();
}

function setTxType(type, btn){
  h_type = type;
  localStorage.setItem('dompet_h_type', type);
  btn.closest('div').querySelectorAll('.pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderHistory();
}

function txHTML(t){
  return `<div class="tx-item">
    <div class="tx-icon" style="background:${CAT_COLOR[t.category]||'#6B7280'}18">${CAT_ICON[t.category]||'üìå'}</div>
    <div style="flex:1;min-width:0">
      <div class="tx-cat">${t.category}${t.tag?`<span class="tag-pill">${t.tag}</span>`:''}</div>
      <div class="tx-meta">${t.note||'‚Äî'}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px">
      <div class="tx-amt" style="color:${t.type==='income'?'var(--green)':'var(--red)'}">${t.type==='income'?'+':'-'}${rp(t.amount)}</div>
      <div class="tx-date">${fmtDate(t.date)}</div>
      <div style="display:flex;gap:4px;margin-top:2px">
        <button class="del-btn" style="color:var(--primary);opacity:.7" onclick="openEditModal('${t.id}')" title="Ubah">‚úèÔ∏è</button>
        <button class="del-btn" onclick="deleteTransaction('${t.id}')" title="Hapus">‚úï</button>
      </div>
    </div>
  </div>`;
}

// ============================================
// EXPORT CSV
// ============================================
function exportCSV(){
  const rows=[['ID','Tipe','Kategori','Jumlah','Catatan','Tag','Tanggal']];
  transactions.forEach(t=>rows.push([t.id,t.type,t.category,t.amount,t.note||'',t.tag||'',t.date]));
  const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='dompet-transaksi.csv';a.click();
  showToast('‚úì File CSV berhasil diunduh!','info');
}

// ============================================
// BUDGET
// ============================================
function saveBudget(){
  const cat=document.getElementById('b-cat').value;
  const amt=parseFloat(document.getElementById('b-amount').value);
  if(!amt){showToast('Isi jumlah anggaran!','err');return;}
  budgets[cat]=amt;
  localStorage.setItem('dompet_budgets',JSON.stringify(budgets));
  closeModal('addBudget');
  document.getElementById('b-amount').value='';
  showToast(`‚úì Anggaran ${cat} disimpan`);
  renderBudget();renderDashboard();
}
function deleteBudget(cat){delete budgets[cat];localStorage.setItem('dompet_budgets',JSON.stringify(budgets));renderBudget();renderDashboard();}

function renderBudget(){
  const now=new Date();
  document.getElementById('bud-month').textContent=now.toLocaleDateString('id-ID',{month:'long',year:'numeric'});
  const spent={};
  transactions.filter(t=>t.type==='expense'&&monthKey(t.date)===nowMonthKey()).forEach(t=>{spent[t.category]=(spent[t.category]||0)+t.amount});

  if(!Object.keys(budgets).length){
    document.getElementById('bud-status').innerHTML='<div class="empty">Belum ada anggaran. Klik "+ Atur Anggaran" untuk mulai.</div>';
    document.getElementById('bud-summary').innerHTML='';return;
  }

  document.getElementById('bud-status').innerHTML=Object.entries(budgets).map(([cat,limit])=>{
    const used=spent[cat]||0;const pct=Math.min(Math.round((used/limit)*100),100);
    const col=pct>=100?'var(--red)':pct>=80?'var(--yellow)':'var(--green)';
    const status=pct>=100?'‚ö†Ô∏è Melebihi!':pct>=80?'‚ö° Hampir batas':'‚úì Aman';
    return `<div class="budget-row">
      <div class="budget-meta">
        <span style="font-size:13px;font-weight:600">${CAT_ICON[cat]||''} ${cat}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="budget-pct" style="color:${col}">${status}</span>
          <button class="btn-icon btn-xs" onclick="deleteBudget('${cat}')" title="Hapus" style="padding:2px 6px">‚úï</button>
        </div>
      </div>
      <div style="font-size:11px;color:var(--sub);margin-bottom:5px">${rp(used)} dari ${rp(limit)} (${pct}%)</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${col}"></div></div>
    </div>`;
  }).join('');

  const totalBudget=Object.values(budgets).reduce((s,v)=>s+v,0);
  const totalSpent=Object.keys(budgets).reduce((s,c)=>s+(spent[c]||0),0);
  const over=Object.entries(budgets).filter(([c,l])=>(spent[c]||0)>l).length;
  document.getElementById('bud-summary').innerHTML=`
    <div style="padding:12px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--sub);margin-bottom:3px">Total Anggaran</div><div style="font-size:18px;font-weight:700">${rp(totalBudget)}</div></div>
    <div style="padding:12px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--sub);margin-bottom:3px">Sudah Digunakan</div><div style="font-size:18px;font-weight:700;color:var(--red)">${rp(totalSpent)}</div></div>
    <div style="padding:12px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--sub);margin-bottom:3px">Sisa Anggaran</div><div style="font-size:18px;font-weight:700;color:var(--green)">${rp(totalBudget-totalSpent)}</div></div>
    <div style="padding:12px 0"><div style="font-size:11px;color:var(--sub);margin-bottom:3px">Kategori Melebihi</div><div style="font-size:18px;font-weight:700;color:${over>0?'var(--red)':'var(--green)'}">${over} kategori</div></div>`;
}

// ============================================
// GOALS
// ============================================
function saveGoal(){
  const name=document.getElementById('g-name').value.trim();
  const target=parseFloat(document.getElementById('g-target').value);
  const current=parseFloat(document.getElementById('g-current').value)||0;
  const deadline=document.getElementById('g-deadline').value;
  if(!name||!target){showToast('Isi nama dan target!','err');return;}
  goals.push({id:Date.now(),name,target,current,deadline});
  localStorage.setItem('dompet_goals',JSON.stringify(goals));
  closeModal('addGoal');showToast('‚úì Target tabungan disimpan');renderGoals();
}
function deleteGoal(id){goals=goals.filter(g=>g.id!==id);localStorage.setItem('dompet_goals',JSON.stringify(goals));renderGoals();}
function addToGoal(id){
  const g=goals.find(g=>g.id===id);if(!g)return;
  const amt=parseFloat(prompt(`Tambah tabungan untuk "${g.name}" (Rp):`));
  if(!amt||isNaN(amt))return;
  g.current=Math.min(g.current+amt,g.target);
  localStorage.setItem('dompet_goals',JSON.stringify(goals));
  showToast('‚úì Tabungan diperbarui');renderGoals();
}

function renderGoals(){
  if(!goals.length){document.getElementById('goals-list').innerHTML='<div class="card"><div class="empty">Belum ada target tabungan. Buat target untuk motivasi lebih!</div></div>';return;}
  document.getElementById('goals-list').innerHTML=goals.map(g=>{
    const pct=Math.min(Math.round((g.current/g.target)*100),100);
    const daysLeft=g.deadline?Math.ceil((new Date(g.deadline)-new Date())/(1000*60*60*24)):null;
    const needed=g.target-g.current;
    return `<div class="goal-card">
      <div class="goal-header">
        <div><div class="goal-name">üèÜ ${g.name}</div><div class="goal-target">${rp(g.current)} / ${rp(g.target)}</div></div>
        <div class="goal-pct">${pct}%</div>
      </div>
      <div class="progress-bar" style="height:8px;margin-bottom:8px"><div class="progress-fill" style="width:${pct}%;background:${pct>=100?'var(--green)':'var(--primary)'}"></div></div>
      ${daysLeft!==null?`<div style="font-size:11px;color:${daysLeft<7?'var(--red)':'var(--sub)'}">‚è∞ ${daysLeft>0?daysLeft+' hari lagi':'Sudah lewat deadline!'}</div>`:''}
      <div style="font-size:11px;color:var(--sub);margin-top:2px">Kurang: ${rp(needed)}</div>
      <div style="display:flex;gap:6px;margin-top:10px">
        ${pct<100?`<button class="btn btn-primary btn-xs" onclick="addToGoal(${g.id})">+ Tambah</button>`:'<span style="color:var(--green);font-size:12px;font-weight:600">üéâ Tercapai!</span>'}
        <button class="btn btn-ghost btn-xs" onclick="deleteGoal(${g.id})">Hapus</button>
      </div>
    </div>`;
  }).join('');
}

// ============================================
// RECURRING
// ============================================
function toggleDueField(prefix){
  const freq=document.getElementById(prefix+'-freq').value;
  const label=document.getElementById(prefix+'-due-label');
  if(!label)return;
  if(freq==='weekly') label.textContent='Jatuh Tempo (hari ke- dalam minggu)';
  else if(freq==='yearly') label.textContent='Jatuh Tempo (tanggal tiap tahun)';
  else label.textContent='Tanggal Jatuh Tempo (hari ke-)';
}

function saveRecurring(){
  const name=document.getElementById('r-name').value.trim();
  const amt=parseFloat(document.getElementById('r-amount').value);
  if(!name||!amt){showToast('Isi nama dan jumlah!','err');return;}
  recurring.push({
    id:Date.now(),name,
    category:document.getElementById('r-cat').value,
    amount:amt,
    freq:document.getElementById('r-freq').value,
    type:document.getElementById('r-type').value,
    due:document.getElementById('r-due').value||'',
    time:document.getElementById('r-time').value||'09:00',
    reminder:document.getElementById('r-reminder').value||'',
    note:document.getElementById('r-note').value||''
  });
  localStorage.setItem('dompet_recurring',JSON.stringify(recurring));
  closeModal('addRecurring');
  document.getElementById('r-name').value='';
  document.getElementById('r-amount').value='';
  document.getElementById('r-note').value='';
  showToast('‚úì Transaksi rutin disimpan');
  renderRecurring();
}

function openEditRecurring(id){
  const r=recurring.find(r=>r.id===id);if(!r)return;
  document.getElementById('er-id').value=r.id;
  document.getElementById('er-name').value=r.name;
  document.getElementById('er-cat').value=r.category;
  document.getElementById('er-amount').value=r.amount;
  document.getElementById('er-freq').value=r.freq;
  document.getElementById('er-type').value=r.type;
  document.getElementById('er-due').value=r.due||'';
  document.getElementById('er-time').value=r.time||'09:00';
  document.getElementById('er-reminder').value=r.reminder||'';
  document.getElementById('er-note').value=r.note||'';
  toggleDueField('er');
  document.getElementById('modal-editRecurring').classList.add('show');
}

function updateRecurring(){
  const id=Number(document.getElementById('er-id').value);
  const name=document.getElementById('er-name').value.trim();
  const amt=parseFloat(document.getElementById('er-amount').value);
  if(!name||!amt){showToast('Isi nama dan jumlah!','err');return;}
  const idx=recurring.findIndex(r=>r.id===id);
  if(idx===-1){showToast('Data tidak ditemukan','err');return;}
  recurring[idx]={
    id,name,
    category:document.getElementById('er-cat').value,
    amount:amt,
    freq:document.getElementById('er-freq').value,
    type:document.getElementById('er-type').value,
    due:document.getElementById('er-due').value||'',
    time:document.getElementById('er-time').value||'09:00',
    reminder:document.getElementById('er-reminder').value||'',
    note:document.getElementById('er-note').value||''
  };
  localStorage.setItem('dompet_recurring',JSON.stringify(recurring));
  closeModal('editRecurring');
  showToast('‚úì Transaksi rutin diperbarui');
  renderRecurring();
}

function deleteRecurring(id){recurring=recurring.filter(r=>r.id!==id);localStorage.setItem('dompet_recurring',JSON.stringify(recurring));renderRecurring();}

async function applyRecurring(id){
  const r=recurring.find(r=>r.id===id);if(!r)return;
  const tx={id:Date.now(),type:r.type,category:r.category,amount:r.amount,note:r.name+' (Rutin)',tag:'#rutin',date:today()};
  try{
    const res=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'add',...tx})});
    const json=await res.json();
    if(json.status==='ok'){transactions.push(tx);showToast('‚úì Dicatat ke Sheets!');renderAll();}
    else throw new Error(json.message);
  } catch(e){showToast('Gagal: '+e.message,'err');}
}

function getDueInfo(r){
  const freqLabel={monthly:'Bulanan',weekly:'Mingguan',yearly:'Tahunan'};
  const now=new Date();
  const todayNum=now.getDate();
  const due=parseInt(r.due)||0;

  let dueTxt='', daysLeft=null, urgency='';

  if(r.due && r.freq==='monthly'){
    // Calculate days until next due date
    let nextDue=new Date(now.getFullYear(),now.getMonth(),due);
    if(nextDue<=now) nextDue=new Date(now.getFullYear(),now.getMonth()+1,due);
    daysLeft=Math.ceil((nextDue-now)/(1000*60*60*24));
    dueTxt=`Jatuh tempo tgl ${due} ¬∑ ${r.time||'09:00'}`;
    if(daysLeft<=0) urgency='overdue';
    else if(daysLeft<=parseInt(r.reminder||0)||daysLeft<=3) urgency='soon';
    else urgency='ok';
  } else if(r.due && r.freq==='weekly'){
    dueTxt=`Jatuh tempo hari ke-${r.due} tiap minggu ¬∑ ${r.time||'09:00'}`;
    urgency='ok';
  } else if(r.due && r.freq==='yearly'){
    dueTxt=`Jatuh tempo tgl ${due} ¬∑ ${r.time||'09:00'}`;
    urgency='ok';
  }

  return {dueTxt, daysLeft, urgency};
}

function renderRecurring(){
  const freqLabel={monthly:'Bulanan',weekly:'Mingguan',yearly:'Tahunan'};
  if(!recurring.length){document.getElementById('recur-list').innerHTML='<div class="empty">Belum ada transaksi rutin.</div>';return;}

  // Sort by due date (soonest first)
  const sorted=[...recurring].sort((a,b)=>{
    const da=parseInt(a.due)||99, db=parseInt(b.due)||99;
    return da-db;
  });

  document.getElementById('recur-list').innerHTML=sorted.map(r=>{
    const {dueTxt,daysLeft,urgency}=getDueInfo(r);
    const urgencyBadge = urgency==='overdue'
      ? `<span style="background:var(--red-light);color:var(--red);font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;margin-left:6px">LEWAT JATUH TEMPO</span>`
      : urgency==='soon' && daysLeft!==null
      ? `<span style="background:var(--yellow-light);color:var(--yellow);font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;margin-left:6px">${daysLeft===0?'HARI INI':daysLeft+'H LAGI'}</span>`
      : daysLeft!==null
      ? `<span style="background:var(--faint);color:var(--sub);font-size:10px;font-weight:600;padding:2px 7px;border-radius:5px;margin-left:6px">${daysLeft}H lagi</span>`
      : '';

    const reminderTxt = r.reminder ? `<span style="font-size:10px;color:var(--sub)">üîî Pengingat H-${r.reminder}</span>` : '';

    return `<div class="recur-item" style="border-left:3px solid ${urgency==='overdue'?'var(--red)':urgency==='soon'?'var(--yellow)':'var(--border)'};padding-left:12px">
      <div style="width:36px;height:36px;border-radius:9px;background:${r.type==='income'?'var(--green-light)':'var(--red-light)'};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${CAT_ICON[r.category]||'üîÅ'}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:2px">
          <span style="font-size:13px;font-weight:700">${r.name}</span>
          ${urgencyBadge}
        </div>
        <div style="font-size:11px;color:var(--sub);margin-top:2px">${r.category} ¬∑ ${freqLabel[r.freq]||r.freq} ¬∑ <span style="color:${r.type==='income'?'var(--green)':'var(--red)'}">${r.type==='income'?'Pemasukan':'Pengeluaran'}</span></div>
        ${dueTxt?`<div style="font-size:11px;color:var(--sub);margin-top:2px">üìÖ ${dueTxt}</div>`:''}
        ${r.note?`<div style="font-size:11px;color:var(--sub);margin-top:1px">üìù ${r.note}</div>`:''}
        ${reminderTxt?`<div style="margin-top:2px">${reminderTxt}</div>`:''}
      </div>
      <div style="text-align:right;margin-right:10px;flex-shrink:0">
        <div style="font-size:14px;font-weight:700;color:${r.type==='income'?'var(--green)':'var(--red)'}">${r.type==='income'?'+':'-'}${rp(r.amount)}</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn btn-primary btn-xs" onclick="applyRecurring(${r.id})">‚ñ∂ Catat</button>
        <button class="btn btn-ghost btn-xs" onclick="openEditRecurring(${r.id})">‚úèÔ∏è Ubah</button>
        <button class="btn btn-ghost btn-xs" style="color:var(--red);border-color:var(--red)" onclick="deleteRecurring(${r.id})">Hapus</button>
      </div>
    </div>`;
  }).join('');
}

// ============================================
// REPORTS
// ============================================
function renderReports(){
  const now=new Date();
  const todayStr=today();
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);
  const curMonth=nowMonthKey();

  // Periods
  const todayTx=transactions.filter(t=>t.date===todayStr);
  const weekTx=transactions.filter(t=>new Date(t.date)>=weekAgo);
  const monthTx=transactions.filter(t=>monthKey(t.date)===curMonth);

  [['rep-today',todayTx],['rep-week',weekTx],['rep-month',monthTx]].forEach(([id,txs])=>{
    const inc=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const exp=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    document.getElementById(id).innerHTML=`
      <div style="margin-bottom:6px"><span style="font-size:11px;color:var(--sub)">Masuk</span><div style="font-weight:700;color:var(--green)">${rp(inc)}</div></div>
      <div style="margin-bottom:6px"><span style="font-size:11px;color:var(--sub)">Keluar</span><div style="font-weight:700;color:var(--red)">${rp(exp)}</div></div>
      <div><span style="font-size:11px;color:var(--sub)">Saldo</span><div style="font-weight:700;color:${inc-exp>=0?'var(--primary)':'var(--red)'}">${rp(inc-exp)}</div></div>
      <div style="font-size:11px;color:var(--sub);margin-top:6px">${txs.length} transaksi</div>`;
  });

  // Income/expense cat
  const incomeCat={},expCat={};
  transactions.forEach(t=>{
    if(t.type==='income') incomeCat[t.category]=(incomeCat[t.category]||0)+t.amount;
    else expCat[t.category]=(expCat[t.category]||0)+t.amount;
  });
  const maxI=Math.max(...Object.values(incomeCat),1);
  const maxE=Math.max(...Object.values(expCat),1);
  document.getElementById('rep-income-cat').innerHTML=Object.entries(incomeCat).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="hbar"><div class="hbar-label">${CAT_ICON[c]||''} ${c}</div>
    <div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxI)*100}%;background:var(--green)"></div></div>
    <div class="hbar-val">${rp(v)}</div></div>`).join('')||'<div class="empty">Belum ada pemasukan</div>';
  document.getElementById('rep-expense-cat').innerHTML=Object.entries(expCat).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="hbar"><div class="hbar-label">${CAT_ICON[c]||''} ${c}</div>
    <div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxE)*100}%;background:${CAT_COLOR[c]||'var(--red)'}"></div></div>
    <div class="hbar-val">${rp(v)}</div></div>`).join('')||'<div class="empty">Belum ada pengeluaran</div>';

  // Monthly table
  const months=[...new Set(transactions.map(t=>monthKey(t.date)).filter(Boolean))].sort().reverse();
  document.getElementById('rep-monthly-table').innerHTML=months.length?`
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr style="border-bottom:2px solid var(--border)">
        <th style="text-align:left;padding:8px 6px;color:var(--sub);font-weight:600">Bulan</th>
        <th style="text-align:right;padding:8px 6px;color:var(--sub);font-weight:600">Pemasukan</th>
        <th style="text-align:right;padding:8px 6px;color:var(--sub);font-weight:600">Pengeluaran</th>
        <th style="text-align:right;padding:8px 6px;color:var(--sub);font-weight:600">Saldo</th>
        <th style="text-align:right;padding:8px 6px;color:var(--sub);font-weight:600">Transaksi</th>
      </tr></thead>
      <tbody>${months.map(m=>{
        const mtx=transactions.filter(t=>monthKey(t.date)===m);
        const inc=mtx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
        const exp=mtx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
        return `<tr style="border-bottom:1px solid var(--border)">
          <td style="padding:8px 6px;font-weight:500">${monthLabel(m)}</td>
          <td style="padding:8px 6px;text-align:right;color:var(--green);font-weight:600">${rp(inc)}</td>
          <td style="padding:8px 6px;text-align:right;color:var(--red);font-weight:600">${rp(exp)}</td>
          <td style="padding:8px 6px;text-align:right;font-weight:700;color:${inc-exp>=0?'var(--primary)':'var(--red)'}">${rp(inc-exp)}</td>
          <td style="padding:8px 6px;text-align:right;color:var(--sub)">${mtx.length}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`:'<div class="empty">Belum ada data</div>';
}

// ============================================
// INSIGHTS
// ============================================
function renderInsights(){
  const income=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance=income-expense;
  const expTx=transactions.filter(t=>t.type==='expense');
  const bycat={};expTx.forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount});
  const topCat=Object.entries(bycat).sort((a,b)=>b[1]-a[1])[0];
  const rate=income>0?Math.round((balance/income)*100):0;

  const insights=[];
  if(income>0){
    if(rate>=30) insights.push({t:'Tabungan Sangat Sehat',c:'green',d:`Rasio tabunganmu ${rate}%, jauh di atas standar minimal 20%. Keuanganmu sangat sehat!`});
    else if(rate>=20) insights.push({t:'Tabungan Cukup',c:'',d:`Rasio tabunganmu ${rate}%, sudah memenuhi standar minimal. Coba tingkatkan ke 30%.`});
    else if(rate>0) insights.push({t:'Tabungan Perlu Ditingkatkan',c:'yellow',d:`Kamu hanya menabung ${rate}%. Target minimal 20% dari pemasukan. Kurangi pengeluaran tidak penting.`});
    else insights.push({t:'Defisit Keuangan',c:'red',d:`Pengeluaranmu melebihi pemasukan sebesar ${rp(Math.abs(balance))}. Segera evaluasi!`});
  }
  if(topCat) insights.push({t:'Pengeluaran Terbesar',c:'yellow',d:`"${topCat[0]}" menyerap ${rp(topCat[1])} (${expense>0?Math.round((topCat[1]/expense)*100):0}% dari total pengeluaran).`});

  const freq={};expTx.forEach(t=>{freq[t.category]=(freq[t.category]||0)+1});
  const topFreq=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
  if(topFreq&&topFreq[1]>2) insights.push({t:'Kategori Paling Sering',c:'',d:`"${topFreq[0]}" dicatat ${topFreq[1]}x. Pertimbangkan budget tetap untuk kategori ini.`});

  const avgPerMonth=expense>0?expense/Math.max([...new Set(transactions.map(t=>monthKey(t.date)).filter(Boolean))].length,1):0;
  if(avgPerMonth>0) insights.push({t:'Rata-rata Pengeluaran Bulanan',c:'',d:`Kamu rata-rata menghabiskan ${rp(Math.round(avgPerMonth))} per bulan.`});

  if(!insights.length) insights.push({t:'Mulai Mencatat',c:'',d:'Tambahkan transaksi untuk mendapatkan analisis yang personal.'});
  document.getElementById('ins-cards').innerHTML=insights.map(i=>`<div class="insight ${i.c}"><div class="insight-title">${i.t}</div><div class="insight-text">${i.d}</div></div>`).join('');

  // Stats
  const avgExp=expTx.length?expense/expTx.length:0;
  const maxExpAmt=expTx.length?Math.max(...expTx.map(t=>t.amount)):0;
  const uniqMonths=[...new Set(transactions.map(t=>monthKey(t.date)).filter(Boolean))].length;
  document.getElementById('ins-stats').innerHTML=[
    ['Total Transaksi',transactions.length+' transaksi'],
    ['Total Kategori',[...new Set(transactions.map(t=>t.category))].length+' kategori'],
    ['Rata-rata Pengeluaran',rp(avgExp)],
    ['Pengeluaran Terbesar',rp(maxExpAmt)],
    ['Bulan Aktif',uniqMonths+' bulan'],
    ['Rasio Pemasukan/Pengeluaran',expense>0?(income/expense*100).toFixed(0)+'%':'‚Äî'],
  ].map(([l,v])=>`<div class="flex-between" style="padding:9px 0;border-bottom:1px solid var(--border)"><span style="font-size:12px;color:var(--sub)">${l}</span><span style="font-size:13px;font-weight:600">${v}</span></div>`).join('');

  // Days
  const dayCount={};
  transactions.filter(t=>t.type==='expense').forEach(t=>{
    const day=new Date(t.date).toLocaleDateString('id-ID',{weekday:'long'});
    dayCount[day]=(dayCount[day]||0)+t.amount;
  });
  const maxDay=Math.max(...Object.values(dayCount),1);
  document.getElementById('ins-days').innerHTML=Object.entries(dayCount).sort((a,b)=>b[1]-a[1]).map(([d,v])=>`
    <div class="hbar"><div class="hbar-label" style="width:90px">${d}</div>
    <div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxDay)*100}%;background:var(--primary)"></div></div>
    <div class="hbar-val">${rp(v)}</div></div>`).join('')||'<div class="empty">Belum ada data</div>';
}

// ============================================
// AI ADVISOR
// ============================================
function setQ(q){document.getElementById('aiInput').value=q;}
function saveKey(){
  const k=document.getElementById('apiKey').value.trim();
  if(k){localStorage.setItem('dompet_key',k);showToast('‚úì API key tersimpan');document.getElementById('apiKey').value='';}
}

async function sendAI(){
  const input=document.getElementById('aiInput');
  const msg=input.value.trim();if(!msg)return;
  const key=localStorage.getItem('dompet_key');
  if(!key){showToast('Masukkan Anthropic API Key dulu!','err');return;}
  input.value='';
  document.getElementById('chatEmpty')?.remove();
  appendChat('user',msg);chatHistory.push({role:'user',content:msg});

  const income=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const bycat={};transactions.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount});
  const budgetInfo=Object.entries(budgets).map(([k,v])=>k+': limit '+rp(v)).join(', ');
  const goalInfo=goals.map(g=>`${g.name}: ${rp(g.current)}/${rp(g.target)}`).join(', ');
  const summary=`Pemasukan: ${rp(income)}, Pengeluaran: ${rp(expense)}, Saldo: ${rp(income-expense)}, Rasio tabungan: ${income>0?Math.round(((income-expense)/income)*100):0}%. Pengeluaran per kategori: ${Object.entries(bycat).map(([k,v])=>k+': '+rp(v)).join(', ')}. Anggaran: ${budgetInfo||'belum diatur'}. Target tabungan: ${goalInfo||'belum ada'}. ${USER_NAME?'Nama pengguna: '+USER_NAME+'.':''} Total ${transactions.length} transaksi.`;

  const typing=document.createElement('div');typing.id='typing';typing.style.display='flex';
  const tb=document.createElement('div');tb.className='cbubble cbubble-ai';
  tb.innerHTML='<span class="qdot"></span><span class="qdot"></span><span class="qdot"></span>';
  typing.appendChild(tb);document.getElementById('chatArea').appendChild(typing);
  scrollChat();document.getElementById('sendBtn').disabled=true;

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,
        system:`Kamu adalah asisten keuangan pribadi bernama "Dompet AI". Jawab dalam bahasa Indonesia yang santai, lugas, dan actionable. Data keuangan: ${summary}`,
        messages:chatHistory})
    });
    const data=await res.json();
    document.getElementById('typing')?.remove();
    const reply=data.content?.[0]?.text||data.error?.message||'Gagal memproses.';
    chatHistory.push({role:'assistant',content:reply});
    appendChat('ai',reply);
  } catch(e){
    document.getElementById('typing')?.remove();
    appendChat('ai','‚ùå Koneksi gagal. Cek API key dan internet.');
  }
  document.getElementById('sendBtn').disabled=false;
}
function appendChat(role,text){
  const area=document.getElementById('chatArea');
  const wrap=document.createElement('div');wrap.style.cssText=`display:flex;justify-content:${role==='user'?'flex-end':'flex-start'}`;
  const bub=document.createElement('div');bub.className=`cbubble cbubble-${role==='user'?'user':'ai'}`;bub.textContent=text;
  wrap.appendChild(bub);area.appendChild(wrap);scrollChat();
}
function scrollChat(){const a=document.getElementById('chatArea');a.scrollTop=a.scrollHeight;}

// ============================================
// THEME
// ============================================
const THEME_LABELS = {light:'Default',dark:'Gelap',forest:'Hutan',rose:'Mawar',slate:'Biru Malam'};

function setTheme(theme) {
  ACTIVE_THEME = theme;
  localStorage.setItem('dompet_theme', theme);
  applyTheme();
  showToast('‚úì Tema ' + THEME_LABELS[theme] + ' diterapkan');
}

function applyTheme() {
  const html = document.documentElement;
  if (ACTIVE_THEME === 'light') html.removeAttribute('data-theme');
  else html.setAttribute('data-theme', ACTIVE_THEME);
  // update swatch active state
  document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
  const sw = document.getElementById('swatch-' + ACTIVE_THEME);
  if (sw) sw.classList.add('active');
  const lbl = document.getElementById('active-theme-label');
  if (lbl) lbl.textContent = THEME_LABELS[ACTIVE_THEME] || ACTIVE_THEME;
}

// ============================================
// DATE SETTINGS
// ============================================

function saveDateSettings() {
  DATE_FMT  = document.getElementById('cfg-datefmt').value;
  DATE_TZ   = document.getElementById('cfg-timezone').value;
  DATE_AUTO = document.getElementById('cfg-autodate').value;
  localStorage.setItem('dompet_datefmt', DATE_FMT);
  localStorage.setItem('dompet_tz', DATE_TZ);
  localStorage.setItem('dompet_autodate', DATE_AUTO);
  updateDatePreview();
  showToast('‚úì Pengaturan tanggal disimpan');
}

function updateDatePreview() {
  const preview = document.getElementById('date-preview');
  const tzInfo  = document.getElementById('date-tz-info');
  if (!preview) return;
  const nowStr = todayInTZ();
  preview.textContent = formatDateDisplay(nowStr);
  const nowLocal = new Date().toLocaleString('id-ID', {timeZone: DATE_TZ, weekday:'long', hour:'2-digit', minute:'2-digit'});
  tzInfo.textContent = `Zona waktu: ${DATE_TZ} ‚Äî Sekarang: ${nowLocal}`;
}

function initDateSettingsUI() {
  const fmt = document.getElementById('cfg-datefmt');
  const tz  = document.getElementById('cfg-timezone');
  const auto= document.getElementById('cfg-autodate');
  if (fmt) fmt.value = DATE_FMT;
  if (tz)  tz.value  = DATE_TZ;
  if (auto) auto.value = DATE_AUTO;
  updateDatePreview();
}

// ============================================
// SETTINGS / CONVERSION
// ============================================
function saveConfig(){
  const url=document.getElementById('cfg-url').value.trim();
  if(url){API_URL=url;localStorage.setItem('dompet_url',url);showToast('‚úì URL disimpan, memuat ulang...');setTimeout(()=>loadData(),500);}
}
function savePref(){
  USER_NAME=document.getElementById('cfg-name').value.trim();
  CURRENCY=document.getElementById('cfg-currency').value;
  localStorage.setItem('dompet_name',USER_NAME);
  localStorage.setItem('dompet_currency',CURRENCY);
  showToast('‚úì Preferensi disimpan');
}
function calcConversion(){
  const amt=parseFloat(document.getElementById('conv-amount').value)||0;
  const from=document.getElementById('conv-from').value;
  const to=document.getElementById('conv-to').value;
  const idr=amt*(RATES[from]||1);
  const result=idr/(RATES[to]||1);
  const fmt=new Intl.NumberFormat('id-ID',{maximumFractionDigits:2}).format(result);
  document.getElementById('conv-result').textContent=`${amt.toLocaleString('id-ID')} ${from} = ${fmt} ${to}`;
}

// ============================================
// CASH MANAGEMENT (KAS USAHA)
// ============================================

function saveAllKasData(){
  localStorage.setItem('dompet_wallets', JSON.stringify(wallets));
  localStorage.setItem('dompet_cash', JSON.stringify(cashTx));
  localStorage.setItem('dompet_piutang', JSON.stringify(piutangList));
  localStorage.setItem('dompet_hutang', JSON.stringify(hutangList));
  localStorage.setItem('dompet_pelunasan', JSON.stringify(pelunasanList));
}

// ----- TABS -----
function showKasTab(tab, btn){
  kasTab = tab;
  ['transaksi','piutang','rekap','pecahan'].forEach(t=>{
    const el = document.getElementById('kastab-content-'+t);
    const b  = document.getElementById('kastab-'+t);
    if(el) el.style.display = t===tab ? '' : 'none';
    if(b)  b.className = 'btn btn-sm ' + (t===tab ? 'btn-primary' : 'btn-ghost');
  });
  if(tab==='rekap') renderKasRekap();
  if(tab==='pecahan') renderDenominations();
  if(tab==='piutang') renderPiutangHutang();
}

// ----- WALLETS -----
function saveWallet(){
  const name = document.getElementById('w-name').value.trim();
  const balance = parseFloat(document.getElementById('w-balance').value)||0;
  const color = document.getElementById('w-color').value;
  if(!name){showToast('Isi nama dompet!','err');return;}
  wallets.push({id:Date.now(), name, balance, color});
  saveAllKasData();
  closeModal('addWallet');
  document.getElementById('w-name').value='';
  document.getElementById('w-balance').value='';
  showToast('‚úì Dompet ditambahkan');
  renderCash();
}
function deleteWallet(id){
  if(!confirm('Hapus dompet ini?'))return;
  wallets = wallets.filter(w=>w.id!==id);
  saveAllKasData(); renderCash();
}
function editWalletBalance(id){
  const w = wallets.find(w=>w.id===id);if(!w)return;
  const val = prompt(`Edit saldo "${w.name}" (Rp):`, w.balance);
  if(val===null)return;
  const num = parseFloat(val);
  if(isNaN(num)){showToast('Jumlah tidak valid','err');return;}
  w.balance = num; saveAllKasData(); showToast('‚úì Saldo diperbarui'); renderCash();
}

// ----- OPEN MODAL HELPER -----
function openCashModal(type){
  cashFormType = type;
  document.getElementById('c-date').value = autoDateValue();
  populateCashWalletSelects();
  setCashFormType(type);
  document.getElementById('modal-addCash').classList.add('show');
}

function setCashFormType(type){
  cashFormType = type;
  const tabs = {setoran:'income', keluar:'expense', transfer:''};
  ['setoran','keluar','transfer'].forEach(t=>{
    const el = document.getElementById('ctab-'+t);
    if(el) el.className = 'type-tab' + (t===type && tabs[t] ? ' '+tabs[t] : (t===type?' active':''));
  });
  const lbl = document.getElementById('cash-wallet-label');
  const toWrap = document.getElementById('c-to-wrap');
  if(type==='transfer'){
    if(lbl) lbl.textContent='Dari Dompet';
    if(toWrap) toWrap.style.display='';
  } else if(type==='setoran'){
    if(lbl) lbl.textContent='Ke Dompet';
    if(toWrap) toWrap.style.display='none';
  } else {
    if(lbl) lbl.textContent='Dari Dompet';
    if(toWrap) toWrap.style.display='none';
  }
}

function populateCashWalletSelects(){
  const opts = wallets.length
    ? wallets.map(w=>`<option value="${w.id}">${w.name}</option>`).join('')
    : '<option value="">‚Äî Belum ada dompet ‚Äî</option>';
  const cw = document.getElementById('c-wallet');
  const cwt = document.getElementById('c-wallet-to');
  if(cw) cw.innerHTML = opts;
  if(cwt) cwt.innerHTML = opts;
}

// ----- ADD CASH TX -----
function addCashTransaction(){
  const amt = parseFloat(document.getElementById('c-amount').value);
  const date = document.getElementById('c-date').value;
  const note = document.getElementById('c-note').value.trim();
  const cat  = document.getElementById('c-cat').value;
  const nama = document.getElementById('c-nama').value.trim();
  if(!amt||!date){showToast('Isi jumlah dan tanggal!','err');return;}

  if(cashFormType === 'transfer'){
    const wId  = Number(document.getElementById('c-wallet').value);
    const toId = Number(document.getElementById('c-wallet-to').value);
    if(wId===toId){showToast('Dompet asal dan tujuan sama!','err');return;}
    const fromW = wallets.find(w=>w.id===wId);
    const toW   = wallets.find(w=>w.id===toId);
    if(!fromW||!toW){showToast('Pilih dompet!','err');return;}
    if(fromW.balance < amt){showToast('Saldo tidak cukup!','err');return;}
    fromW.balance -= amt; toW.balance += amt;
    cashTx.push({id:Date.now(), type:'transfer', fromWallet:wId, toWallet:toId,
      fromName:fromW.name, toName:toW.name, amount:amt, cat, note, nama, date});
  } else {
    const wId = Number(document.getElementById('c-wallet').value);
    const w = wallets.find(w=>w.id===wId);
    if(!w){showToast('Pilih dompet!','err');return;}
    if(cashFormType==='keluar' && w.balance < amt){showToast('Saldo tidak cukup!','err');return;}
    w.balance += cashFormType==='setoran' ? amt : -amt;
    cashTx.push({id:Date.now(), type:cashFormType, wallet:wId, walletName:w.name,
      amount:amt, cat, note, nama, date});
  }

  saveAllKasData();
  closeModal('addCash');
  document.getElementById('c-amount').value='';
  document.getElementById('c-note').value='';
  document.getElementById('c-nama').value='';
  showToast('‚úì Transaksi kas disimpan');
  renderCash();
}

// ----- EDIT CASH TX -----
function openEditCash(id){
  const t = cashTx.find(t=>t.id===id);if(!t)return;
  document.getElementById('ec-id').value = t.id;
  document.getElementById('ec-amount').value = t.amount;
  document.getElementById('ec-date').value = t.date;
  document.getElementById('ec-cat').value = t.cat||'Lainnya';
  document.getElementById('ec-note').value = t.note||'';
  document.getElementById('ec-nama').value = t.nama||'';
  document.getElementById('modal-editCash').classList.add('show');
}
function updateCashTransaction(){
  const id = Number(document.getElementById('ec-id').value);
  const newAmt = parseFloat(document.getElementById('ec-amount').value);
  const date = document.getElementById('ec-date').value;
  if(!newAmt||!date){showToast('Isi jumlah dan tanggal!','err');return;}
  const idx = cashTx.findIndex(t=>t.id===id);if(idx===-1)return;
  const t = cashTx[idx];
  const diff = newAmt - t.amount;
  if(t.type==='setoran'){const w=wallets.find(w=>w.id===t.wallet);if(w) w.balance+=diff;}
  else if(t.type==='keluar'){const w=wallets.find(w=>w.id===t.wallet);if(w) w.balance-=diff;}
  cashTx[idx] = {...t, amount:newAmt, date,
    cat:document.getElementById('ec-cat').value,
    note:document.getElementById('ec-note').value,
    nama:document.getElementById('ec-nama').value};
  saveAllKasData(); closeModal('editCash'); showToast('‚úì Diperbarui'); renderCash();
}
function deleteCashTx(id){
  if(!confirm('Hapus transaksi ini?'))return;
  const t = cashTx.find(t=>t.id===id);
  if(t){
    if(t.type==='setoran'){const w=wallets.find(w=>w.id===t.wallet);if(w) w.balance-=t.amount;}
    else if(t.type==='keluar'){const w=wallets.find(w=>w.id===t.wallet);if(w) w.balance+=t.amount;}
    else if(t.type==='transfer'){
      const fw=wallets.find(w=>w.id===t.fromWallet);if(fw) fw.balance+=t.amount;
      const tw=wallets.find(w=>w.id===t.toWallet);if(tw) tw.balance-=t.amount;
    }
  }
  cashTx = cashTx.filter(t=>t.id!==id);
  saveAllKasData(); showToast('‚úì Dihapus'); renderCash();
}

// ----- PIUTANG / HUTANG -----
function savePiutang(){
  const nama = document.getElementById('p-nama').value.trim();
  const amt = parseFloat(document.getElementById('p-amount').value);
  const date = document.getElementById('p-date').value;
  if(!nama||!amt||!date){showToast('Isi nama, jumlah, dan tanggal!','err');return;}
  piutangList.push({id:Date.now(), nama, amount:amt, date,
    due:document.getElementById('p-due').value||'',
    note:document.getElementById('p-note').value||'',
    lunas:false, sisaAmount:amt});
  saveAllKasData(); closeModal('addPiutang');
  document.getElementById('p-nama').value='';document.getElementById('p-amount').value='';
  document.getElementById('p-note').value='';document.getElementById('p-due').value='';
  showToast('‚úì Piutang dicatat'); renderPiutangHutang();
}
function saveHutang(){
  const nama = document.getElementById('h-nama').value.trim();
  const amt = parseFloat(document.getElementById('h-amount').value);
  const date = document.getElementById('h-date').value;
  if(!nama||!amt||!date){showToast('Isi nama, jumlah, dan tanggal!','err');return;}
  hutangList.push({id:Date.now(), nama, amount:amt, date,
    due:document.getElementById('h-due').value||'',
    note:document.getElementById('h-note').value||'',
    lunas:false, sisaAmount:amt});
  saveAllKasData(); closeModal('addHutang');
  document.getElementById('h-nama').value='';document.getElementById('h-amount').value='';
  document.getElementById('h-note').value='';document.getElementById('h-due').value='';
  showToast('‚úì Hutang dicatat'); renderPiutangHutang();
}

function openLunasi(id, type){
  document.getElementById('lunasi-id').value = id;
  document.getElementById('lunasi-type').value = type;
  document.getElementById('lunasi-date').value = autoDateValue();
  document.getElementById('lunasi-amount').value = '';
  document.getElementById('lunasi-note').value = '';
  const list = type==='piutang' ? piutangList : hutangList;
  const item = list.find(x=>x.id===id);
  if(!item)return;
  document.getElementById('lunasi-title').innerHTML =
    `‚úÖ ${type==='piutang'?'Terima Pembayaran':'Bayar Hutang'} ‚Äî ${item.nama} <button class="modal-close" onclick="closeModal('lunasiDebt')">√ó</button>`;
  document.getElementById('lunasi-info').innerHTML =
    `<b>${item.nama}</b><br>Jumlah awal: <b>${rp(item.amount)}</b> | Sisa: <b style="color:var(--red)">${rp(item.sisaAmount)}</b><br>${item.note?'Catatan: '+item.note:''}`;
  document.getElementById('lunasi-amount').placeholder = item.sisaAmount;
  document.getElementById('modal-lunasiDebt').classList.add('show');
}

function lunasiDebt(){
  const id = Number(document.getElementById('lunasi-id').value);
  const type = document.getElementById('lunasi-type').value;
  const bayar = parseFloat(document.getElementById('lunasi-amount').value);
  const date = document.getElementById('lunasi-date').value;
  const note = document.getElementById('lunasi-note').value;
  if(!bayar||!date){showToast('Isi jumlah dan tanggal!','err');return;}
  const list = type==='piutang' ? piutangList : hutangList;
  const item = list.find(x=>x.id===id);
  if(!item)return;
  item.sisaAmount = Math.max(0, item.sisaAmount - bayar);
  if(item.sisaAmount <= 0) item.lunas = true;
  pelunasanList.push({id:Date.now(), refId:id, type, nama:item.nama,
    bayar, date, note, lunasPenuh: item.lunas});
  saveAllKasData(); closeModal('lunasiDebt');
  showToast(item.lunas ? '‚úÖ Lunas!' : '‚úì Pembayaran dicatat');
  renderPiutangHutang();
}

function hapusPiutang(id){
  if(!confirm('Hapus data piutang ini?'))return;
  piutangList = piutangList.filter(x=>x.id!==id);
  saveAllKasData(); renderPiutangHutang();
}
function hapusHutang(id){
  if(!confirm('Hapus data hutang ini?'))return;
  hutangList = hutangList.filter(x=>x.id!==id);
  saveAllKasData(); renderPiutangHutang();
}

// ----- DENOMINATION -----
function renderDenominations(){
  const list = document.getElementById('denomination-list');
  if(!list) return;
  list.innerHTML = DENOMINATIONS.map(d=>`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <div style="width:90px;font-size:12px;font-weight:600">${rp(d)}</div>
      <button class="btn btn-ghost btn-xs" style="padding:3px 8px" onclick="changeDenom(${d},-1)">‚àí</button>
      <input type="number" min="0" value="${denomCounts[d]||0}" style="width:60px;text-align:center;padding:4px 6px;font-size:13px" oninput="setDenom(${d},this.value)">
      <button class="btn btn-ghost btn-xs" style="padding:3px 8px" onclick="changeDenom(${d},1)">+</button>
      <div style="font-size:11px;color:var(--sub);min-width:80px;text-align:right">${rp(d*(denomCounts[d]||0))}</div>
    </div>`).join('');
  updateDenomTotal();
}
function changeDenom(d, delta){
  denomCounts[d] = Math.max(0,(denomCounts[d]||0)+delta);
  localStorage.setItem('dompet_denom', JSON.stringify(denomCounts));
  renderDenominations();
}
function setDenom(d, val){
  denomCounts[d] = Math.max(0, parseInt(val)||0);
  localStorage.setItem('dompet_denom', JSON.stringify(denomCounts));
  updateDenomTotal();
}
function updateDenomTotal(){
  const total = DENOMINATIONS.reduce((s,d)=>s+d*(denomCounts[d]||0),0);
  const el = document.getElementById('denomination-total');
  if(el) el.innerHTML = `<div class="flex-between"><span style="font-weight:700;font-size:13px">Total Uang</span><span style="font-size:18px;font-weight:800;color:#CA8A04">${rp(total)}</span></div>`;
}
function resetDenomination(){
  if(!confirm('Reset semua hitungan pecahan?'))return;
  denomCounts={};localStorage.setItem('dompet_denom',JSON.stringify(denomCounts));renderDenominations();
}

// ----- FILTER -----
function setKasType(type, btn){
  kasTypeFilter = type;
  btn.closest('div').querySelectorAll('.pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderKasHistory();
}

// ----- EXPORT -----
function exportCashCSV(){
  const rows=[['Tipe','Nama/Pelanggan','Jumlah','Kategori','Keterangan','Tanggal']];
  cashTx.forEach(t=>rows.push([
    t.type==='transfer'?`Transfer (${t.fromName}‚Üí${t.toName})`:t.type==='setoran'?'Setoran Masuk':'Pengeluaran',
    t.nama||'', t.amount, t.cat||'', t.note||'', t.date
  ]));
  rows.push(['','','','','','']);
  rows.push(['=== PIUTANG ===','','','','','']);
  rows.push(['Nama','Jumlah','Sisa','Jatuh Tempo','Catatan','Status']);
  piutangList.forEach(p=>rows.push([p.nama,p.amount,p.sisaAmount,p.due||'',p.note||'',p.lunas?'Lunas':'Belum Lunas']));
  rows.push(['','','','','','']);
  rows.push(['=== HUTANG ===','','','','','']);
  hutangList.forEach(h=>rows.push([h.nama,h.amount,h.sisaAmount,h.due||'',h.note||'',h.lunas?'Lunas':'Belum Lunas']));
  const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='dompet-kas-usaha.csv';a.click();
  showToast('‚úì File CSV kas diunduh!','info');
}

// ----- RENDER MAIN -----
function renderCash(){
  renderKasStats();
  renderKasWallets();
  renderKasHistory();
  renderPiutangHutang();
  populateCashWalletSelects();
  updateKasMonthFilter();
  if(kasTab==='rekap') renderKasRekap();
  if(kasTab==='pecahan') renderDenominations();
}

function renderKasStats(){
  const saldo = wallets.reduce((s,w)=>s+w.balance,0);
  const setoranTx = cashTx.filter(t=>t.type==='setoran');
  const keluarTx  = cashTx.filter(t=>t.type==='keluar');
  const totalSetoran = setoranTx.reduce((s,t)=>s+t.amount,0);
  const totalKeluar  = keluarTx.reduce((s,t)=>s+t.amount,0);
  const piutangAktif = piutangList.filter(p=>!p.lunas);
  const totalPiutang = piutangAktif.reduce((s,p)=>s+p.sisaAmount,0);

  document.getElementById('kas-saldo').textContent = rp(saldo);
  document.getElementById('kas-saldo-sub').textContent = wallets.length+' dompet';
  document.getElementById('kas-masuk').textContent = rp(totalSetoran);
  document.getElementById('kas-masuk-sub').textContent = setoranTx.length+' setoran';
  document.getElementById('kas-keluar').textContent = rp(totalKeluar);
  document.getElementById('kas-keluar-sub').textContent = keluarTx.length+' transaksi';
  document.getElementById('kas-piutang').textContent = rp(totalPiutang);
  document.getElementById('kas-piutang-sub').textContent = piutangAktif.length+' pelanggan belum bayar';
}

function renderKasWallets(){
  const el = document.getElementById('kas-wallets');if(!el)return;
  if(!wallets.length){el.innerHTML='<div class="empty">Belum ada dompet.<br>Klik "+ Tambah Dompet" untuk mulai.</div>';return;}
  el.innerHTML = wallets.map(w=>`
    <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="width:36px;height:36px;border-radius:9px;background:${w.color}22;display:flex;align-items:center;justify-content:center;font-size:18px;border:2px solid ${w.color}44">üíµ</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:13px">${w.name}</div>
        <div style="font-size:18px;font-weight:800;color:${w.color}">${rp(w.balance)}</div>
      </div>
      <div style="display:flex;gap:5px">
        <button class="btn btn-ghost btn-xs" onclick="editWalletBalance(${w.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-ghost btn-xs" style="color:var(--red);border-color:var(--red)" onclick="deleteWallet(${w.id})">Hapus</button>
      </div>
    </div>`).join('');
}

function updateKasMonthFilter(){
  const sel = document.getElementById('kas-month-filter');if(!sel)return;
  const cur = sel.value;
  const months = [...new Set(cashTx.map(t=>monthKey(t.date)).filter(Boolean))].sort().reverse();
  sel.innerHTML = '<option value="">Semua Bulan</option>' +
    months.map(m=>`<option value="${m}" ${m===cur?'selected':''}>${monthLabel(m)}</option>`).join('');
}

function renderKasHistory(){
  const el = document.getElementById('kas-history-list');if(!el)return;
  const search = (document.getElementById('kas-search')?.value||'').toLowerCase();
  const mFilter = document.getElementById('kas-month-filter')?.value||'';

  let filtered = [...cashTx].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(kasTypeFilter!=='all') filtered = filtered.filter(t=>t.type===kasTypeFilter);
  if(mFilter) filtered = filtered.filter(t=>monthKey(t.date)===mFilter);
  if(search) filtered = filtered.filter(t=>
    (t.nama||'').toLowerCase().includes(search) ||
    (t.note||'').toLowerCase().includes(search) ||
    (t.cat||'').toLowerCase().includes(search)
  );

  // Summary bar
  const masuk  = filtered.filter(t=>t.type==='setoran').reduce((s,t)=>s+t.amount,0);
  const keluar = filtered.filter(t=>t.type==='keluar').reduce((s,t)=>s+t.amount,0);
  const sb = document.getElementById('kas-summary-bar');
  if(sb) sb.innerHTML = `
    <span style="font-size:12px"><b style="color:var(--green)">Setoran: ${rp(masuk)}</b></span>
    <span style="font-size:12px"><b style="color:var(--red)">Keluar: ${rp(keluar)}</b></span>
    <span style="font-size:12px;color:var(--sub)">Net: <b style="color:${masuk-keluar>=0?'var(--primary)':'var(--red)'}">${rp(masuk-keluar)}</b></span>
    <span style="font-size:12px;color:var(--sub)">${filtered.length} transaksi</span>`;

  if(!filtered.length){el.innerHTML='<div class="empty">Belum ada transaksi kas.</div>';return;}

  const typeIcon  = {setoran:'üì•', keluar:'üì§', transfer:'üîÑ'};
  const typeColor = {setoran:'var(--green)', keluar:'var(--red)', transfer:'var(--primary)'};
  const typeLabel = {setoran:'Setoran', keluar:'Keluar', transfer:'Transfer'};

  el.innerHTML = filtered.map(t=>`
    <div class="tx-item">
      <div class="tx-icon" style="background:${typeColor[t.type]}18;font-size:16px">${typeIcon[t.type]||'üíµ'}</div>
      <div style="flex:1;min-width:0">
        <div class="tx-cat">
          ${t.nama ? `<b>${t.nama}</b>` : (t.type==='transfer'?`${t.fromName}‚Üí${t.toName}`:'‚Äî')}
          <span style="background:${typeColor[t.type]}18;color:${typeColor[t.type]};font-size:10px;font-weight:700;padding:1px 6px;border-radius:5px;margin-left:5px">${typeLabel[t.type]||t.type}</span>
        </div>
        <div class="tx-meta">${t.cat||''}${t.note?' ¬∑ '+t.note:''}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px">
        <div style="font-size:14px;font-weight:700;color:${typeColor[t.type]}">
          ${t.type==='setoran'?'+':t.type==='keluar'?'-':''}${rp(t.amount)}
        </div>
        <div class="tx-date">${fmtDate(t.date)}</div>
        <div style="display:flex;gap:4px">
          ${t.type!=='transfer'?`<button class="del-btn" style="color:var(--primary);opacity:.7" onclick="openEditCash(${t.id})">‚úèÔ∏è</button>`:''}
          <button class="del-btn" onclick="deleteCashTx(${t.id})">‚úï</button>
        </div>
      </div>
    </div>`).join('');
}

function renderPiutangHutang(){
  // Piutang
  const elP = document.getElementById('list-piutang');
  const aktifP = piutangList.filter(p=>!p.lunas);
  const lunasP = piutangList.filter(p=>p.lunas);
  if(elP){
    if(!piutangList.length){elP.innerHTML='<div class="empty">Belum ada piutang.</div>';}
    else{
      elP.innerHTML = [...aktifP, ...lunasP].map(p=>{
        const overdue = p.due && !p.lunas && new Date(p.due) < new Date();
        const daysLeft = p.due && !p.lunas ? Math.ceil((new Date(p.due)-new Date())/(1000*60*60*24)) : null;
        return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
          <div class="flex-between">
            <div>
              <div style="font-weight:700;font-size:13px">${p.nama}
                ${p.lunas?'<span style="background:#dcfce7;color:#16a34a;font-size:10px;padding:1px 6px;border-radius:5px;margin-left:5px">‚úì Lunas</span>':
                  overdue?'<span style="background:#fee2e2;color:var(--red);font-size:10px;padding:1px 6px;border-radius:5px;margin-left:5px">Terlambat</span>':
                  daysLeft!==null?`<span style="background:var(--faint);color:var(--sub);font-size:10px;padding:1px 6px;border-radius:5px;margin-left:5px">${daysLeft}h lagi</span>`:''}
              </div>
              <div style="font-size:11px;color:var(--sub)">Pinjam: ${fmtDate(p.date)}${p.due?' | Tempo: '+fmtDate(p.due):''}${p.note?' | '+p.note:''}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:var(--primary)">${rp(p.amount)}</div>
              ${!p.lunas?`<div style="font-size:11px;color:var(--red)">Sisa: ${rp(p.sisaAmount)}</div>`:''}
            </div>
          </div>
          ${!p.lunas?`<div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn btn-primary btn-xs" onclick="openLunasi(${p.id},'piutang')">‚úÖ Tandai Sudah Bayar</button>
            <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="hapusPiutang(${p.id})">Hapus</button>
          </div>`:'<div style="margin-top:4px"><button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="hapusPiutang('+p.id+')">Hapus</button></div>'}
        </div>`;
      }).join('');
    }
    const totalSisaP = aktifP.reduce((s,p)=>s+p.sisaAmount,0);
    document.getElementById('total-piutang').innerHTML =
      aktifP.length ? `Tagihan belum bayar: <span style="color:var(--primary)">${rp(totalSisaP)}</span> dari ${aktifP.length} pelanggan` : 'Semua pelanggan sudah bayar ‚úì';
  }

  // Hutang
  const elH = document.getElementById('list-hutang');
  const aktifH = hutangList.filter(h=>!h.lunas);
  if(elH){
    if(!hutangList.length){elH.innerHTML='<div class="empty">Belum ada hutang.</div>';}
    else{
      elH.innerHTML = hutangList.map(h=>{
        const overdue = h.due && !h.lunas && new Date(h.due) < new Date();
        return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
          <div class="flex-between">
            <div>
              <div style="font-weight:700;font-size:13px">${h.nama}
                ${h.lunas?'<span style="background:#dcfce7;color:#16a34a;font-size:10px;padding:1px 6px;border-radius:5px;margin-left:5px">‚úì Lunas</span>':
                  overdue?'<span style="background:#fee2e2;color:var(--red);font-size:10px;padding:1px 6px;border-radius:5px;margin-left:5px">Terlambat</span>':''}
              </div>
              <div style="font-size:11px;color:var(--sub)">Pinjam: ${fmtDate(h.date)}${h.due?' | Tempo: '+fmtDate(h.due):''}${h.note?' | '+h.note:''}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:var(--red)">${rp(h.amount)}</div>
              ${!h.lunas?`<div style="font-size:11px;color:var(--red)">Sisa: ${rp(h.sisaAmount)}</div>`:''}
            </div>
          </div>
          ${!h.lunas?`<div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn btn-primary btn-xs" onclick="openLunasi(${h.id},'hutang')">üí∏ Bayar</button>
            <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="hapusHutang(${h.id})">Hapus</button>
          </div>`:'<div style="margin-top:4px"><button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="hapusHutang('+h.id+')">Hapus</button></div>'}
        </div>`;
      }).join('');
    }
    const totalSisaH = aktifH.reduce((s,h)=>s+h.sisaAmount,0);
    document.getElementById('total-hutang').innerHTML =
      aktifH.length ? `Hutang aktif: <span style="color:var(--red)">${rp(totalSisaH)}</span> kepada ${aktifH.length} pihak` : 'Semua hutang lunas ‚úì';
  }

  // Riwayat pelunasan
  const elPel = document.getElementById('list-pelunasan');
  if(elPel){
    if(!pelunasanList.length){elPel.innerHTML='<div class="empty">Belum ada riwayat pelunasan.</div>';return;}
    elPel.innerHTML = [...pelunasanList].reverse().map(p=>`
      <div class="tx-item">
        <div class="tx-icon" style="background:var(--green)18">‚úÖ</div>
        <div style="flex:1">
          <div class="tx-cat">${p.nama} <span style="font-size:10px;color:var(--sub);font-weight:500">${p.type==='piutang'?'(Terima Bayar)':'(Bayar Hutang)'}</span></div>
          <div class="tx-meta">${p.note||''}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700;color:var(--green)">+${rp(p.bayar)}</div>
          <div class="tx-date">${fmtDate(p.date)}</div>
          ${p.lunasPenuh?'<div style="font-size:10px;color:var(--green)">Lunas penuh ‚úì</div>':''}
        </div>
      </div>`).join('');
  }
}

function renderKasRekap(){
  // Harian 30 hari
  const elH = document.getElementById('kas-rekap-harian');
  if(elH){
    const days = [];
    for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toLocaleDateString('en-CA'));}
    const dayData = days.map(d=>({
      date:d,
      masuk: cashTx.filter(t=>t.date===d&&t.type==='setoran').reduce((s,t)=>s+t.amount,0),
      keluar: cashTx.filter(t=>t.date===d&&t.type==='keluar').reduce((s,t)=>s+t.amount,0)
    })).filter(d=>d.masuk||d.keluar).reverse().slice(0,15);
    elH.innerHTML = dayData.length ? dayData.map(d=>`
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <div style="width:85px;color:var(--sub)">${fmtDate(d.date)}</div>
        <div style="flex:1">
          ${d.masuk?`<div style="color:var(--green)">+${rp(d.masuk)}</div>`:''}
          ${d.keluar?`<div style="color:var(--red)">-${rp(d.keluar)}</div>`:''}
        </div>
        <div style="font-weight:700;color:${d.masuk-d.keluar>=0?'var(--primary)':'var(--red)'}">${rp(d.masuk-d.keluar)}</div>
      </div>`).join('') : '<div class="empty">Belum ada data</div>';
  }

  // Bulanan
  const elB = document.getElementById('kas-rekap-bulanan');
  if(elB){
    const months = [...new Set(cashTx.map(t=>monthKey(t.date)).filter(Boolean))].sort().reverse();
    elB.innerHTML = months.length ? months.map(m=>{
      const masuk  = cashTx.filter(t=>monthKey(t.date)===m&&t.type==='setoran').reduce((s,t)=>s+t.amount,0);
      const keluar = cashTx.filter(t=>monthKey(t.date)===m&&t.type==='keluar').reduce((s,t)=>s+t.amount,0);
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">
        <div style="font-weight:600">${monthLabel(m)}</div>
        <div style="text-align:right">
          <div style="color:var(--green)">+${rp(masuk)}</div>
          <div style="color:var(--red)">-${rp(keluar)}</div>
          <div style="font-weight:700;color:${masuk-keluar>=0?'var(--primary)':'var(--red)'}">${rp(masuk-keluar)}</div>
        </div>
      </div>`;
    }).join('') : '<div class="empty">Belum ada data</div>';
  }

  // Per kategori
  const elK = document.getElementById('kas-rekap-kategori');
  if(elK){
    const bycat={};
    cashTx.filter(t=>t.type==='keluar').forEach(t=>{bycat[t.cat||'Lainnya']=(bycat[t.cat||'Lainnya']||0)+t.amount});
    const maxV = Math.max(...Object.values(bycat),1);
    elK.innerHTML = Object.entries(bycat).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
      <div class="hbar">
        <div class="hbar-label">${CAT_ICON[c]||'üìå'} ${c}</div>
        <div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxV)*100}%;background:var(--red)"></div></div>
        <div class="hbar-val">${rp(v)}</div>
      </div>`).join('') || '<div class="empty">Belum ada pengeluaran</div>';
  }
}

// ============================================
// NAV
// ============================================
function showPage(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(el) el.classList.add('active');
  if(id==='cash') renderCash();
}

// ============================================
// INIT
// ============================================
// Apply theme immediately
applyTheme();

const now=new Date();
document.getElementById('headerDate').textContent=now.toLocaleDateString('id-ID',{timeZone:DATE_TZ,weekday:'long',day:'numeric',month:'long',year:'numeric'});
document.getElementById('cfg-url').value=API_URL;
if(USER_NAME) document.getElementById('cfg-name').value=USER_NAME;
document.getElementById('cfg-currency').value=CURRENCY;
updateFormCats();
document.getElementById('f-date').value=autoDateValue();
document.getElementById('c-date').value=autoDateValue();
document.getElementById('p-date').value=autoDateValue();
document.getElementById('h-date').value=autoDateValue();
populateCashWalletSelects();
initDateSettingsUI();
// ============================================
// PWA ‚Äî Service Worker & Offline Detection
// ============================================
let deferredInstallPrompt = null;

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('[PWA] Service Worker registered:', reg.scope);
        // Listen for updates
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showToast('üîÑ Update tersedia! Refresh untuk versi terbaru.', 'info');
            }
          });
        });
      })
      .catch(err => console.warn('[PWA] SW registration failed:', err));

    // Listen for sync messages from SW
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data?.type === 'SYNC_NOW') loadData();
    });
  });
}

// Offline/Online detection
function updateOnlineStatus() {
  const banner = document.getElementById('offline-banner');
  if (!navigator.onLine) {
    banner.classList.add('show');
    setSyncStatus('err', 'Offline');
  } else {
    banner.classList.remove('show');
    // Auto sync saat kembali online
    loadData();
  }
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
if (!navigator.onLine) document.getElementById('offline-banner').classList.add('show');

// PWA Install Prompt
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  document.getElementById('pwa-install-btn').classList.add('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('pwa-install-btn').classList.remove('show');
  showToast('‚úÖ Dompet berhasil diinstall!');
});
function installPWA() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(choice => {
    if (choice.outcome === 'accepted') showToast('üéâ Instalasi berhasil!');
    deferredInstallPrompt = null;
    document.getElementById('pwa-install-btn').classList.remove('show');
  });
}
</script>
</body>
</html>
